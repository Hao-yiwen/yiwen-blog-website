# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## 项目概述

这是一个基于 Docusaurus 3.6.3 构建的技术博客网站（yiwen-blog-website），专注于软件开发和人工智能领域。博客主要使用中文，内容涵盖多个技术领域，通过不同的侧边栏组织。

**技术栈:**
- Docusaurus 3.6.3 (React 18.2)
- TypeScript 5.1
- Prism React Renderer (代码语法高亮)
- KaTeX (数学公式渲染)
- Giscus (评论系统，基于 GitHub Discussions)

**系统要求:**
- Node.js >= 18.0
- 使用 npm 或 yarn 包管理器

## 内容组织

网站使用 `sidebars.js` 中定义的多侧边栏架构，所有侧边栏都使用 `type: 'autogenerated'`，这意味着 `docs/` 目录结构会直接决定导航结构。

### 侧边栏结构

- **aiSidebar** (人工智能): `docs/ai/`
  - `base/` - 机器学习基础
  - `cnn/` - 卷积神经网络
  - `compute/` - 计算相关
  - `huggingface/` - Hugging Face 相关
  - `mlp/` - 多层感知机
  - `python/` - Python 编程
  - `pytorch/` - PyTorch 框架

- **nativeSidebar** (Native开发): `docs/native/`
  - `ios/` - iOS 开发 (Swift/SwiftUI/UIKit)
  - `android/` - Android 开发
  - `ReactNative/` - React Native
  - `flutter/` - Flutter 开发
  - `harmony/` - HarmonyOS 开发

- **webSidebar** (Web开发): `docs/web/`
  - `React/` - React 框架
  - `Nextjs/` - Next.js 框架
  - `Css/` - CSS 样式
  - `Js/` - JavaScript
  - `Antd/`, `Mini/`, `Rollup/`, `Umi/`, `taro/`, `react_debugger/` 等

- **backendSidebar** (服务端开发): `docs/backend/`
  - `java/` - Java 开发
  - `mysql/` - MySQL 数据库
  - `redis/` - Redis 缓存

- **csSidebar** (计算机基础): `docs/cs_base/`
  - `arithmetic/` - 算法
  - `pattern/` - 设计模式
  - `cs_internet/` - 计算机网络
  - `compression/` - 压缩算法
  - `web_pattern/` - Web 设计模式

- **whelkSidebar** (抗痘): `docs/whelk/`
  - `2023/`, `2024/` - 按年份组织的个人健康内容

## 常用开发命令

### 开发
```bash
npm install          # 安装依赖
npm start           # 启动开发服务器 (localhost:3000)
npm run serve       # 本地预览生产构建
```

### 构建和部署
```bash
npm run build       # 构建生产站点
npm run deploy      # 部署到 GitHub Pages
npm run clear       # 清除 Docusaurus 缓存
```

### 代码质量
```bash
npm run typecheck   # 运行 TypeScript 类型检查
npm run lint:css    # 使用 stylelint 检查 CSS 文件
npx lint-staged     # 运行 pre-commit 检查（Prettier + CSS lint）
```

### Docusaurus 工具
```bash
npm run swizzle                 # 自定义 Docusaurus 组件
npm run write-translations      # 提取 i18n 翻译
npm run write-heading-ids       # 为 markdown 添加标题 ID
```

## 架构说明

### 配置文件

#### docusaurus.config.js
主配置文件，使用异步函数模式支持 ESM 导入（remark-math, rehype-katex）

**关键配置:**
- **Base URL**: `/yiwen-blog-website/` (GitHub Pages 子目录部署)
- **i18n**: 支持 `zh`（默认）和 `en` 语言
- **数学公式渲染**: 通过 remark-math 和 rehype-katex 插件使用 KaTeX
- **搜索**: 使用 `@easyops-cn/docusaurus-search-local` 支持中英文搜索
- **Markdown 格式**: MDX，支持在 markdown 中使用 React 组件
- **侧边栏配置**:
  - `sidebarCollapsed: false` - 全局禁用侧边栏折叠
  - `showLastUpdateTime: true` - 显示文档最后更新时间
  - `showLastUpdateAuthor: false` - 不显示更新作者
- **博客配置**:
  - `showReadingTime: true` - 显示阅读时间
  - `blogSidebarCount: 'ALL'` - 显示所有博客文章

#### 代码质量配置

**Prettier (.prettierrc):**
```json
{
  "printWidth": 80,
  "tabWidth": 4,
  "useTabs": false,
  "semi": true,
  "singleQuote": true,
  "trailingComma": "es5",
  "arrowParens": "avoid"
}
```

**Stylelint (.stylelintrc):**
- 扩展 `stylelint-config-recommended`
- 允许的单位: `em`, `rem`, `s`, `%`, `px`
- 忽略 `build/**/*` 目录

**CommitLint (commitlint.config.js):**
- 使用 `@commitlint/config-conventional` 规范
- 强制 conventional commits 格式 (feat:, fix:, docs:, etc.)

### 自定义组件

**评论系统 (src/components/Comment.tsx):**
- 使用 Giscus 集成 GitHub Discussions
- 基于 `@giscus/react` 包实现
- 在文档页面和博客文章页面自动显示

**Swizzled 主题组件:**
- `src/theme/DocItem/Layout/index.tsx` - 为文档页面添加评论区
- `src/theme/BlogPostPage/index.tsx` - 为博客文章添加评论区
- `src/theme/BlogPostPage/Metadata/index.tsx` - 博客文章元数据组件

### 目录结构

```
yiwen-blog-website/
├── .github/workflows/     # GitHub Actions 工作流
├── .husky/               # Git hooks 配置
├── docs/                 # 文档内容（按领域组织）
│   ├── ai/              # 人工智能
│   ├── native/          # Native 开发
│   ├── web/             # Web 开发
│   ├── backend/         # 后端开发
│   ├── cs_base/         # 计算机基础
│   └── whelk/           # 个人健康
├── blog/                # 博客文章
├── src/                 # 源代码
│   ├── components/      # React 组件
│   ├── css/            # 自定义样式
│   └── theme/          # Swizzled 主题组件
├── static/             # 静态资源（图片、图标等）
├── docusaurus.config.js # Docusaurus 主配置
├── sidebars.js         # 侧边栏配置
├── package.json        # 项目依赖和脚本
└── tsconfig.json       # TypeScript 配置
```

**重要说明:**
- `docs/` 目录结构直接决定导航结构（autogenerated sidebars）
- 所有 markdown 文件支持 MDX 格式，可以使用 React 组件
- `static/` 目录中的文件会被直接复制到构建输出
- `blog/` 目录中的文章会自动生成博客页面，支持标签和分类

## Git 工作流

### Pre-commit Hooks (Husky)

项目使用 Husky 8.0.3 管理 Git hooks，配置文件位于 `.husky/` 目录：

**pre-commit hook (.husky/pre-commit):**
```bash
npx lint-staged
```
自动运行 lint-staged，对暂存文件执行：
- Prettier 格式化: `*.{js,json,md,ts}` 文件
- Stylelint 检查: `src/**/*.css` 文件

**commit-msg hook (.husky/commit-msg):**
```bash
npx commitlint --edit "$1"
```
强制使用 conventional commit 格式，确保提交消息符合规范。

**Conventional Commits 示例:**
```bash
feat: 添加新的博客文章
fix: 修复导航栏样式问题
docs: 更新 README 文档
style: 调整代码格式
refactor: 重构评论组件
test: 添加单元测试
chore: 更新依赖包
```

### CI/CD

项目使用 GitHub Actions 实现自动化构建和部署，配置文件位于 `.github/workflows/` 目录：

#### 1. GitHub Pages 自动部署 (docker-build.yml)

**触发条件:** 推送到 `master` 分支

**工作流程:**
1. Checkout 代码 (actions/checkout@v4)
2. 设置 Node.js 20 环境，使用 yarn cache
3. 安装依赖: `yarn install --frozen-lockfile`
4. 构建项目: `yarn build`
5. 部署到 GitHub Pages (peaceiris/actions-gh-pages@v3)
   - 发布到 `gh-pages` 分支
   - 需要 `PERSONAL_ACCESS_TOKEN` secret

**部署 URL:** https://hao-yiwen.github.io/yiwen-blog-website/

#### 2. Docker 镜像构建和推送 (docker-build-and-push.yml)

**触发条件:** 推送版本标签 (`v*` 格式，如 `v1.0.0`)

**工作流程:**
1. Checkout 代码
2. 登录阿里云容器镜像服务
3. 提取 Git tag 作为版本号
4. 构建 Docker 镜像 (linux/amd64 平台)
5. 推送镜像到阿里云

**所需 Secrets:**
- `ALIYUN_CONTAINER_REGISTRY_USERNAME` - 阿里云容器镜像服务用户名
- `ALIYUN_CONTAINER_REGISTRY_PASSWORD` - 阿里云容器镜像服务密码
- `ALIYUN_CONTAINER_REGISTRY_NAMESPACE` - 阿里云命名空间
- `PERSONAL_ACCESS_TOKEN` - GitHub Personal Access Token

**镜像仓库:** `registry.cn-shanghai.aliyuncs.com/<namespace>/yiwen-blog-website:<version>`

### Docker 部署

**Dockerfile 说明:**
```dockerfile
# 阶段 1: 构建 (Node 16-alpine)
- 复制 package.json 和 yarn.lock
- 安装依赖 (yarn install --frozen-lockfile)
- 构建项目 (yarn build)

# 阶段 2: 生产 (Nginx-alpine)
- 从构建阶段复制 build 文件到 /usr/share/nginx/html
- 暴露 80 端口
- 运行 Nginx
```

**构建目标平台:** linux/amd64

**本地 Docker 测试:**
```bash
# 构建镜像
docker build -t yiwen-blog:latest .

# 运行容器
docker run -p 8080:80 yiwen-blog:latest

# 访问 http://localhost:8080
```

### 分支策略

- **主分支:** `master` - 生产环境，自动部署到 GitHub Pages
- **功能分支:** 使用描述性名称创建功能分支（如 `feature/add-new-section`, `fix/navbar-bug`）
- **Claude 分支:** 以 `claude/` 开头的分支用于 Claude Code 开发
- **发布流程:**
  1. 在功能分支开发和测试
  2. 合并到 master 分支
  3. 打 tag 触发 Docker 构建: `git tag v1.0.0 && git push origin v1.0.0`

## 语法高亮

在 `docusaurus.config.js` 中配置了 Prism 支持多种编程语言：

```javascript
prism: {
  theme: lightCodeTheme,        // GitHub 主题（浅色）
  darkTheme: darkCodeTheme,     // Dracula 主题（深色）
  additionalLanguages: [
    'swift',      // iOS 开发
    'java',       // Java/Android 开发
    'bash',       // Shell 脚本
    'dart',       // Flutter 开发
    'go',         // Go 语言
    'sql',        // 数据库查询
    'objectivec', // Objective-C
    'cpp',        // C++
    'ruby',       // Ruby
    'kotlin',     // Kotlin/Android
  ]
}
```

**使用示例:**
````markdown
```swift
let greeting = "Hello, World!"
print(greeting)
```
````

## 实用工具

### add-frontmatter.js

自动为 markdown 文件添加或更新 frontmatter 的 Node.js 脚本。

**功能:**
- 从 Git 历史获取文件的创建时间（首次提交）
- 为文档文件添加 `date` 字段
- 保留现有的 frontmatter 字段

**使用方法:**
```bash
node add-frontmatter.js
```

**注意:** 仅在需要批量更新文档元数据时使用此脚本。

## 开发最佳实践

### 添加新文档

1. **选择正确的目录:**
   - 将文档放在 `docs/` 下对应的主题目录中
   - 文档会自动出现在相应的侧边栏

2. **文件命名:**
   - 使用描述性的文件名，支持中英文
   - 避免空格，使用下划线或连字符
   - 示例: `pytorch_basics.md`, `react-hooks.md`

3. **Frontmatter 示例:**
   ```markdown
   ---
   title: PyTorch 基础教程
   sidebar_position: 1
   tags: [pytorch, 深度学习, 教程]
   ---
   ```

4. **使用数学公式:**
   ```markdown
   行内公式: $E = mc^2$

   块级公式:
   $$
   f(x) = \int_{-\infty}^{\infty} e^{-x^2} dx
   $$
   ```

5. **引用图片:**
   ```markdown
   ![描述文字](/img/your-image.png)
   # 或使用 MDX import
   import ImageComponent from '@site/static/img/your-image.png';
   ```

### 添加博客文章

1. **在 `blog/` 目录创建文件:**
   ```markdown
   ---
   title: 文章标题
   authors: [yiwen]
   tags: [react, tutorial]
   date: 2024-11-15
   ---

   文章摘要...

   <!--truncate-->

   文章正文...
   ```

2. **支持的 frontmatter 字段:**
   - `title` - 文章标题
   - `authors` - 作者列表
   - `tags` - 标签
   - `date` - 发布日期
   - `slug` - 自定义 URL

### Swizzling 组件

当需要自定义 Docusaurus 主题组件时：

```bash
npm run swizzle @docusaurus/theme-classic ComponentName
```

**已 swizzled 的组件:**
- `DocItem/Layout` - 文档页面布局
- `BlogPostPage` - 博客文章页面
- `BlogPostPage/Metadata` - 博客元数据

**警告:** Swizzled 组件可能在 Docusaurus 更新时需要手动维护。

### TypeScript 使用

项目支持 TypeScript，配置基于 `@tsconfig/docusaurus`：

```bash
# 运行类型检查
npm run typecheck
```

**注意:** `tsconfig.json` 主要用于编辑器支持，不参与实际编译。

## 故障排查

### 常见问题

**1. 构建失败 - 模块未找到**
```bash
# 清除缓存并重新安装
npm run clear
rm -rf node_modules package-lock.json
npm install
```

**2. Markdown 渲染错误**
- 检查 frontmatter 格式是否正确（YAML 语法）
- 确保代码块正确闭合
- 使用 MDX 语法时检查 React 组件导入

**3. 数学公式不显示**
- 确保使用正确的 KaTeX 语法
- 检查浏览器控制台是否有错误
- 确认 KaTeX CSS 已正确加载

**4. 搜索功能不工作**
```bash
# 重新构建搜索索引
npm run build
```

**5. Git hooks 不执行**
```bash
# 重新安装 husky
npm install husky --save-dev
npx husky install
```

### 调试技巧

**本地开发调试:**
```bash
# 启用详细日志
npm start -- --verbose

# 使用特定主机和端口
npm start -- --host 0.0.0.0 --port 3001
```

**生产构建调试:**
```bash
# 构建并本地预览
npm run build
npm run serve

# 检查构建输出
ls -la build/
```

## 性能优化

### 图片优化

- 使用 WebP 格式减小文件大小
- 压缩图片后再添加到 `static/img/`
- 大图片使用 CDN 托管

### 构建优化

- 定期运行 `npm run clear` 清除缓存
- 使用 `--no-minify` 调试构建问题
- 检查 bundle 大小: 构建后查看 `build/` 目录

## 重要提示

### 配置相关
- 配置文件 `docusaurus.config.js` 使用异步函数模式 - 添加插件时保持这个模式
- 全局禁用了侧边栏折叠（`sidebarCollapsed: false`）
- Base URL 设置为 `/yiwen-blog-website/`，修改时需同步更新 GitHub Pages 配置

### 内容相关
- 中文内容是主要内容 - 添加英文翻译时保持 i18n 目录结构
- 添加新文档时，将其放在 `docs/` 下的相应目录中，会自动生成侧边栏条目
- 数学表达式支持已配置（remark-math 和 rehype-katex）
- 所有 markdown 文件支持 MDX 格式，可以直接使用 React 组件

### 部署相关
- Docker 构建目标平台为 linux/amd64
- GitHub Pages 自动部署从 `master` 分支触发
- 版本标签 (v*) 会触发 Docker 镜像构建

### 代码质量
- 提交前会自动运行 Prettier 格式化和 Stylelint 检查
- Commit 消息必须符合 conventional commits 规范
- 使用 `npm run typecheck` 检查 TypeScript 类型错误

## 资源链接

- **Docusaurus 文档:** https://docusaurus.io/docs
- **Prism 支持的语言:** https://prismjs.com/#supported-languages
- **KaTeX 文档:** https://katex.org/docs/supported.html
- **Giscus 配置:** https://giscus.app/
- **Conventional Commits:** https://www.conventionalcommits.org/
- **GitHub Pages 文档:** https://docs.github.com/en/pages

## 许可证

MIT License - 详见 LICENSE 文件

## 联系方式

- **GitHub:** [@Hao-yiwen](https://github.com/Hao-yiwen)
- **网站:** https://hao-yiwen.github.io/yiwen-blog-website/
