"use strict";(globalThis.webpackChunkyiwen_blog_website=globalThis.webpackChunkyiwen_blog_website||[]).push([[10323],{28453(s,e,a){a.d(e,{R:()=>t,x:()=>r});var n=a(96540);const l={},i=n.createContext(l);function t(s){const e=n.useContext(i);return n.useMemo(function(){return"function"==typeof s?s(e):{...e,...s}},[e,s])}function r(s){let e;return e=s.disableParentContext?"function"==typeof s.components?s.components(l):s.components||l:t(s.components),n.createElement(i.Provider,{value:e},s.children)}},69215(s,e,a){a.r(e),a.d(e,{assets:()=>m,contentTitle:()=>r,default:()=>d,frontMatter:()=>t,metadata:()=>n,toc:()=>c});const n=JSON.parse('{"id":"ai/architectures/transformer/gqa","title":"Grouped Query Attention (GQA)","description":"1. \u6982\u8ff0 (Overview)","source":"@site/docs/ai/architectures/transformer/gqa.md","sourceDirName":"ai/architectures/transformer","slug":"/ai/architectures/transformer/gqa","permalink":"/yiwen-blog-website/docs/ai/architectures/transformer/gqa","draft":false,"unlisted":false,"editUrl":"https://github.com/Hao-yiwen/yiwen-blog-website/tree/master/docs/ai/architectures/transformer/gqa.md","tags":[{"inline":true,"label":"transformer","permalink":"/yiwen-blog-website/docs/tags/transformer"},{"inline":true,"label":"attention","permalink":"/yiwen-blog-website/docs/tags/attention"},{"inline":true,"label":"gqa","permalink":"/yiwen-blog-website/docs/tags/gqa"},{"inline":true,"label":"mha","permalink":"/yiwen-blog-website/docs/tags/mha"},{"inline":true,"label":"mqa","permalink":"/yiwen-blog-website/docs/tags/mqa"},{"inline":true,"label":"kv-cache","permalink":"/yiwen-blog-website/docs/tags/kv-cache"},{"inline":true,"label":"inference-optimization","permalink":"/yiwen-blog-website/docs/tags/inference-optimization"}],"version":"current","lastUpdatedAt":1765065600000,"frontMatter":{"title":"Grouped Query Attention (GQA)","sidebar_label":"GQA \u5206\u7ec4\u67e5\u8be2\u6ce8\u610f\u529b","date":"2025-12-07T00:00:00.000Z","last_update":{"date":"2025-12-07T00:00:00.000Z"},"tags":["transformer","attention","gqa","mha","mqa","kv-cache","inference-optimization"]},"sidebar":"aiSidebar","previous":{"title":"GPT-2 \u6781\u7b80\u5b9e\u73b0","permalink":"/yiwen-blog-website/docs/ai/architectures/transformer/gpt2_simple"},"next":{"title":"KV Cache \u63a8\u7406\u673a\u5236","permalink":"/yiwen-blog-website/docs/ai/architectures/transformer/kv-cache"}}');var l=a(74848),i=a(28453);const t={title:"Grouped Query Attention (GQA)",sidebar_label:"GQA \u5206\u7ec4\u67e5\u8be2\u6ce8\u610f\u529b",date:new Date("2025-12-07T00:00:00.000Z"),last_update:{date:new Date("2025-12-07T00:00:00.000Z")},tags:["transformer","attention","gqa","mha","mqa","kv-cache","inference-optimization"]},r="Grouped Query Attention (GQA) \u6280\u672f\u6587\u6863",m={},c=[{value:"1. \u6982\u8ff0 (Overview)",id:"1-\u6982\u8ff0-overview",level:2},{value:"\u6838\u5fc3\u4ef7\u503c",id:"\u6838\u5fc3\u4ef7\u503c",level:3},{value:"2. \u67b6\u6784\u539f\u7406 (Architecture)",id:"2-\u67b6\u6784\u539f\u7406-architecture",level:2},{value:"2.1 \u7ed3\u6784\u5bf9\u6bd4",id:"21-\u7ed3\u6784\u5bf9\u6bd4",level:3},{value:"2.2 \u5206\u7ec4\u673a\u5236",id:"22-\u5206\u7ec4\u673a\u5236",level:3},{value:"3. \u5b9e\u73b0\u7ec6\u8282 (Implementation)",id:"3-\u5b9e\u73b0\u7ec6\u8282-implementation",level:2},{value:"3.1 \u6838\u5fc3\u4ee3\u7801\u903b\u8f91",id:"31-\u6838\u5fc3\u4ee3\u7801\u903b\u8f91",level:3},{value:"4. \u6027\u80fd\u5206\u6790 (Performance Analysis)",id:"4-\u6027\u80fd\u5206\u6790-performance-analysis",level:2},{value:"4.1 \u663e\u5b58\u5360\u7528 (Memory Footprint)",id:"41-\u663e\u5b58\u5360\u7528-memory-footprint",level:3},{value:"4.2 \u7cbe\u5ea6\u5f71\u54cd (Accuracy)",id:"42-\u7cbe\u5ea6\u5f71\u54cd-accuracy",level:3},{value:"5. \u6700\u4f73\u5b9e\u8df5\u4e0e\u914d\u7f6e (Best Practices)",id:"5-\u6700\u4f73\u5b9e\u8df5\u4e0e\u914d\u7f6e-best-practices",level:2},{value:"5.1 \u53c2\u6570\u9009\u62e9",id:"51-\u53c2\u6570\u9009\u62e9",level:3},{value:"5.2 \u5e38\u89c1\u5f00\u6e90\u6a21\u578b\u6848\u4f8b",id:"52-\u5e38\u89c1\u5f00\u6e90\u6a21\u578b\u6848\u4f8b",level:3},{value:"6. \u5e38\u89c1\u95ee\u9898 (FAQ)",id:"6-\u5e38\u89c1\u95ee\u9898-faq",level:2},{value:"7. \u53c2\u8003\u8d44\u6599",id:"7-\u53c2\u8003\u8d44\u6599",level:2}];function h(s){const e={a:"a",annotation:"annotation",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",math:"math",mfrac:"mfrac",mi:"mi",mn:"mn",mo:"mo",mrow:"mrow",msub:"msub",mtext:"mtext",p:"p",pre:"pre",semantics:"semantics",span:"span",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,i.R)(),...s.components};return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(e.header,{children:(0,l.jsx)(e.h1,{id:"grouped-query-attention-gqa-\u6280\u672f\u6587\u6863",children:"Grouped Query Attention (GQA) \u6280\u672f\u6587\u6863"})}),"\n",(0,l.jsx)(e.h2,{id:"1-\u6982\u8ff0-overview",children:"1. \u6982\u8ff0 (Overview)"}),"\n",(0,l.jsxs)(e.p,{children:[(0,l.jsx)(e.strong,{children:"Grouped Query Attention (GQA)"})," \u662f\u4e00\u79cd\u7528\u4e8e Transformer \u6a21\u578b\u7684\u9ad8\u6548\u6ce8\u610f\u529b\u673a\u5236\u3002\u5b83\u7531 Google Research \u5728 2023 \u5e74\u63d0\u51fa\uff08\u8bba\u6587\uff1a",(0,l.jsx)(e.em,{children:"GQA: Training Generalized Multi-Query Transformer Models"}),"\uff09\u3002"]}),"\n",(0,l.jsxs)(e.p,{children:["GQA \u662f ",(0,l.jsx)(e.strong,{children:"Multi-Head Attention (MHA)"})," \u548c ",(0,l.jsx)(e.strong,{children:"Multi-Query Attention (MQA)"})," \u4e4b\u95f4\u7684\u63d2\u503c\u65b9\u6848\u3002\u65e8\u5728\u89e3\u51b3\u5927\u8bed\u8a00\u6a21\u578b\uff08LLM\uff09\u5728\u957f\u4e0a\u4e0b\u6587\u63a8\u7406\u65f6\u7684\u663e\u5b58\u74f6\u9888\u95ee\u9898\uff0c\u540c\u65f6\u4fdd\u6301\u63a5\u8fd1 MHA \u7684\u6a21\u578b\u6027\u80fd\u3002"]}),"\n",(0,l.jsx)(e.h3,{id:"\u6838\u5fc3\u4ef7\u503c",children:"\u6838\u5fc3\u4ef7\u503c"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.strong,{children:"\u964d\u4f4e\u663e\u5b58\u5360\u7528\uff1a"})," \u663e\u8457\u51cf\u5c0f KV Cache \u7684\u5927\u5c0f\uff08\u901a\u5e38\u51cf\u5c11 4-8 \u500d\uff09\u3002"]}),"\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.strong,{children:"\u63d0\u5347\u63a8\u7406\u901f\u5ea6\uff1a"})," \u51cf\u5c11\u5185\u5b58\u5e26\u5bbd\u538b\u529b\uff0c\u5927\u5e45\u63d0\u5347 Decoding \u9636\u6bb5\u7684\u541e\u5410\u91cf\u3002"]}),"\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.strong,{children:"\u4fdd\u6301\u9ad8\u7cbe\u5ea6\uff1a"})," \u6027\u80fd\u8868\u73b0\u4f18\u4e8e MQA\uff0c\u51e0\u4e4e\u7b49\u540c\u4e8e MHA\u3002"]}),"\n"]}),"\n",(0,l.jsx)(e.hr,{}),"\n",(0,l.jsx)(e.h2,{id:"2-\u67b6\u6784\u539f\u7406-architecture",children:"2. \u67b6\u6784\u539f\u7406 (Architecture)"}),"\n",(0,l.jsx)(e.h3,{id:"21-\u7ed3\u6784\u5bf9\u6bd4",children:"2.1 \u7ed3\u6784\u5bf9\u6bd4"}),"\n",(0,l.jsxs)(e.p,{children:["\u4e3a\u4e86\u7406\u89e3 GQA\uff0c\u6211\u4eec\u9700\u8981\u5c06\u5176\u4e0e\u4f20\u7edf\u7684 MHA \u548c\u6fc0\u8fdb\u7684 MQA \u8fdb\u884c\u5bf9\u6bd4\u3002\u5047\u8bbe Query \u5934\u6570\u4e3a ",(0,l.jsxs)(e.span,{className:"katex",children:[(0,l.jsx)(e.span,{className:"katex-mathml",children:(0,l.jsx)(e.math,{xmlns:"http://www.w3.org/1998/Math/MathML",children:(0,l.jsxs)(e.semantics,{children:[(0,l.jsx)(e.mrow,{children:(0,l.jsx)(e.mi,{children:"H"})}),(0,l.jsx)(e.annotation,{encoding:"application/x-tex",children:"H"})]})})}),(0,l.jsx)(e.span,{className:"katex-html","aria-hidden":"true",children:(0,l.jsxs)(e.span,{className:"base",children:[(0,l.jsx)(e.span,{className:"strut",style:{height:"0.6833em"}}),(0,l.jsx)(e.span,{className:"mord mathnormal",style:{marginRight:"0.08125em"},children:"H"})]})})]}),"\uff1a"]}),"\n",(0,l.jsxs)(e.table,{children:[(0,l.jsx)(e.thead,{children:(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.th,{style:{textAlign:"left"},children:"\u67b6\u6784"}),(0,l.jsx)(e.th,{style:{textAlign:"left"},children:"Query \u5934\u6570"}),(0,l.jsx)(e.th,{style:{textAlign:"left"},children:"Key/Value \u5934\u6570"}),(0,l.jsxs)(e.th,{style:{textAlign:"left"},children:["\u6bd4\u4f8b (Q",":KV",")"]}),(0,l.jsx)(e.th,{style:{textAlign:"left"},children:"\u7279\u70b9"})]})}),(0,l.jsxs)(e.tbody,{children:[(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{style:{textAlign:"left"},children:(0,l.jsx)(e.strong,{children:"MHA (Multi-Head)"})}),(0,l.jsx)(e.td,{style:{textAlign:"left"},children:(0,l.jsxs)(e.span,{className:"katex",children:[(0,l.jsx)(e.span,{className:"katex-mathml",children:(0,l.jsx)(e.math,{xmlns:"http://www.w3.org/1998/Math/MathML",children:(0,l.jsxs)(e.semantics,{children:[(0,l.jsx)(e.mrow,{children:(0,l.jsx)(e.mi,{children:"H"})}),(0,l.jsx)(e.annotation,{encoding:"application/x-tex",children:"H"})]})})}),(0,l.jsx)(e.span,{className:"katex-html","aria-hidden":"true",children:(0,l.jsxs)(e.span,{className:"base",children:[(0,l.jsx)(e.span,{className:"strut",style:{height:"0.6833em"}}),(0,l.jsx)(e.span,{className:"mord mathnormal",style:{marginRight:"0.08125em"},children:"H"})]})})]})}),(0,l.jsx)(e.td,{style:{textAlign:"left"},children:(0,l.jsxs)(e.span,{className:"katex",children:[(0,l.jsx)(e.span,{className:"katex-mathml",children:(0,l.jsx)(e.math,{xmlns:"http://www.w3.org/1998/Math/MathML",children:(0,l.jsxs)(e.semantics,{children:[(0,l.jsx)(e.mrow,{children:(0,l.jsx)(e.mi,{children:"H"})}),(0,l.jsx)(e.annotation,{encoding:"application/x-tex",children:"H"})]})})}),(0,l.jsx)(e.span,{className:"katex-html","aria-hidden":"true",children:(0,l.jsxs)(e.span,{className:"base",children:[(0,l.jsx)(e.span,{className:"strut",style:{height:"0.6833em"}}),(0,l.jsx)(e.span,{className:"mord mathnormal",style:{marginRight:"0.08125em"},children:"H"})]})})]})}),(0,l.jsx)(e.td,{style:{textAlign:"left"},children:"1 : 1"}),(0,l.jsx)(e.td,{style:{textAlign:"left"},children:"\u8d28\u91cf\u6700\u9ad8\uff0c\u663e\u5b58\u5360\u7528\u6781\u5927\u3002"})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{style:{textAlign:"left"},children:(0,l.jsx)(e.strong,{children:"GQA (Grouped-Query)"})}),(0,l.jsx)(e.td,{style:{textAlign:"left"},children:(0,l.jsxs)(e.span,{className:"katex",children:[(0,l.jsx)(e.span,{className:"katex-mathml",children:(0,l.jsx)(e.math,{xmlns:"http://www.w3.org/1998/Math/MathML",children:(0,l.jsxs)(e.semantics,{children:[(0,l.jsx)(e.mrow,{children:(0,l.jsx)(e.mi,{children:"H"})}),(0,l.jsx)(e.annotation,{encoding:"application/x-tex",children:"H"})]})})}),(0,l.jsx)(e.span,{className:"katex-html","aria-hidden":"true",children:(0,l.jsxs)(e.span,{className:"base",children:[(0,l.jsx)(e.span,{className:"strut",style:{height:"0.6833em"}}),(0,l.jsx)(e.span,{className:"mord mathnormal",style:{marginRight:"0.08125em"},children:"H"})]})})]})}),(0,l.jsxs)(e.td,{style:{textAlign:"left"},children:[(0,l.jsxs)(e.span,{className:"katex",children:[(0,l.jsx)(e.span,{className:"katex-mathml",children:(0,l.jsx)(e.math,{xmlns:"http://www.w3.org/1998/Math/MathML",children:(0,l.jsxs)(e.semantics,{children:[(0,l.jsx)(e.mrow,{children:(0,l.jsx)(e.mi,{children:"G"})}),(0,l.jsx)(e.annotation,{encoding:"application/x-tex",children:"G"})]})})}),(0,l.jsx)(e.span,{className:"katex-html","aria-hidden":"true",children:(0,l.jsxs)(e.span,{className:"base",children:[(0,l.jsx)(e.span,{className:"strut",style:{height:"0.6833em"}}),(0,l.jsx)(e.span,{className:"mord mathnormal",children:"G"})]})})]})," (\u5176\u4e2d ",(0,l.jsxs)(e.span,{className:"katex",children:[(0,l.jsx)(e.span,{className:"katex-mathml",children:(0,l.jsx)(e.math,{xmlns:"http://www.w3.org/1998/Math/MathML",children:(0,l.jsxs)(e.semantics,{children:[(0,l.jsxs)(e.mrow,{children:[(0,l.jsx)(e.mn,{children:"1"}),(0,l.jsx)(e.mo,{children:"<"}),(0,l.jsx)(e.mi,{children:"G"}),(0,l.jsx)(e.mo,{children:"<"}),(0,l.jsx)(e.mi,{children:"H"})]}),(0,l.jsx)(e.annotation,{encoding:"application/x-tex",children:"1 < G < H"})]})})}),(0,l.jsxs)(e.span,{className:"katex-html","aria-hidden":"true",children:[(0,l.jsxs)(e.span,{className:"base",children:[(0,l.jsx)(e.span,{className:"strut",style:{height:"0.6835em",verticalAlign:"-0.0391em"}}),(0,l.jsx)(e.span,{className:"mord",children:"1"}),(0,l.jsx)(e.span,{className:"mspace",style:{marginRight:"0.2778em"}}),(0,l.jsx)(e.span,{className:"mrel",children:"<"}),(0,l.jsx)(e.span,{className:"mspace",style:{marginRight:"0.2778em"}})]}),(0,l.jsxs)(e.span,{className:"base",children:[(0,l.jsx)(e.span,{className:"strut",style:{height:"0.7224em",verticalAlign:"-0.0391em"}}),(0,l.jsx)(e.span,{className:"mord mathnormal",children:"G"}),(0,l.jsx)(e.span,{className:"mspace",style:{marginRight:"0.2778em"}}),(0,l.jsx)(e.span,{className:"mrel",children:"<"}),(0,l.jsx)(e.span,{className:"mspace",style:{marginRight:"0.2778em"}})]}),(0,l.jsxs)(e.span,{className:"base",children:[(0,l.jsx)(e.span,{className:"strut",style:{height:"0.6833em"}}),(0,l.jsx)(e.span,{className:"mord mathnormal",style:{marginRight:"0.08125em"},children:"H"})]})]})]}),")"]}),(0,l.jsxs)(e.td,{style:{textAlign:"left"},children:[(0,l.jsxs)(e.span,{className:"katex",children:[(0,l.jsx)(e.span,{className:"katex-mathml",children:(0,l.jsx)(e.math,{xmlns:"http://www.w3.org/1998/Math/MathML",children:(0,l.jsxs)(e.semantics,{children:[(0,l.jsx)(e.mrow,{children:(0,l.jsx)(e.mi,{children:"R"})}),(0,l.jsx)(e.annotation,{encoding:"application/x-tex",children:"R"})]})})}),(0,l.jsx)(e.span,{className:"katex-html","aria-hidden":"true",children:(0,l.jsxs)(e.span,{className:"base",children:[(0,l.jsx)(e.span,{className:"strut",style:{height:"0.6833em"}}),(0,l.jsx)(e.span,{className:"mord mathnormal",style:{marginRight:"0.00773em"},children:"R"})]})})]})," : 1"]}),(0,l.jsx)(e.td,{style:{textAlign:"left"},children:(0,l.jsx)(e.strong,{children:"\u8d28\u91cf\u4e0e\u901f\u5ea6\u7684\u6700\u4f73\u5e73\u8861\u3002"})})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{style:{textAlign:"left"},children:(0,l.jsx)(e.strong,{children:"MQA (Multi-Query)"})}),(0,l.jsx)(e.td,{style:{textAlign:"left"},children:(0,l.jsxs)(e.span,{className:"katex",children:[(0,l.jsx)(e.span,{className:"katex-mathml",children:(0,l.jsx)(e.math,{xmlns:"http://www.w3.org/1998/Math/MathML",children:(0,l.jsxs)(e.semantics,{children:[(0,l.jsx)(e.mrow,{children:(0,l.jsx)(e.mi,{children:"H"})}),(0,l.jsx)(e.annotation,{encoding:"application/x-tex",children:"H"})]})})}),(0,l.jsx)(e.span,{className:"katex-html","aria-hidden":"true",children:(0,l.jsxs)(e.span,{className:"base",children:[(0,l.jsx)(e.span,{className:"strut",style:{height:"0.6833em"}}),(0,l.jsx)(e.span,{className:"mord mathnormal",style:{marginRight:"0.08125em"},children:"H"})]})})]})}),(0,l.jsx)(e.td,{style:{textAlign:"left"},children:"1"}),(0,l.jsxs)(e.td,{style:{textAlign:"left"},children:[(0,l.jsxs)(e.span,{className:"katex",children:[(0,l.jsx)(e.span,{className:"katex-mathml",children:(0,l.jsx)(e.math,{xmlns:"http://www.w3.org/1998/Math/MathML",children:(0,l.jsxs)(e.semantics,{children:[(0,l.jsx)(e.mrow,{children:(0,l.jsx)(e.mi,{children:"H"})}),(0,l.jsx)(e.annotation,{encoding:"application/x-tex",children:"H"})]})})}),(0,l.jsx)(e.span,{className:"katex-html","aria-hidden":"true",children:(0,l.jsxs)(e.span,{className:"base",children:[(0,l.jsx)(e.span,{className:"strut",style:{height:"0.6833em"}}),(0,l.jsx)(e.span,{className:"mord mathnormal",style:{marginRight:"0.08125em"},children:"H"})]})})]})," : 1"]}),(0,l.jsx)(e.td,{style:{textAlign:"left"},children:"\u901f\u5ea6\u6700\u5feb\uff0c\u4f46\u8d28\u91cf\u6709\u635f\u8017\u3002"})]})]})]}),"\n",(0,l.jsx)(e.h3,{id:"22-\u5206\u7ec4\u673a\u5236",children:"2.2 \u5206\u7ec4\u673a\u5236"}),"\n",(0,l.jsxs)(e.p,{children:["\u5728 GQA \u4e2d\uff0c\u6211\u4eec\u5c06 Query \u5934\u5206\u6210 ",(0,l.jsxs)(e.span,{className:"katex",children:[(0,l.jsx)(e.span,{className:"katex-mathml",children:(0,l.jsx)(e.math,{xmlns:"http://www.w3.org/1998/Math/MathML",children:(0,l.jsxs)(e.semantics,{children:[(0,l.jsx)(e.mrow,{children:(0,l.jsx)(e.mi,{children:"G"})}),(0,l.jsx)(e.annotation,{encoding:"application/x-tex",children:"G"})]})})}),(0,l.jsx)(e.span,{className:"katex-html","aria-hidden":"true",children:(0,l.jsxs)(e.span,{className:"base",children:[(0,l.jsx)(e.span,{className:"strut",style:{height:"0.6833em"}}),(0,l.jsx)(e.span,{className:"mord mathnormal",children:"G"})]})})]})," \u4e2a\u7ec4\uff0c\u6bcf\u7ec4\u5305\u542b ",(0,l.jsxs)(e.span,{className:"katex",children:[(0,l.jsx)(e.span,{className:"katex-mathml",children:(0,l.jsx)(e.math,{xmlns:"http://www.w3.org/1998/Math/MathML",children:(0,l.jsxs)(e.semantics,{children:[(0,l.jsx)(e.mrow,{children:(0,l.jsx)(e.mi,{children:"R"})}),(0,l.jsx)(e.annotation,{encoding:"application/x-tex",children:"R"})]})})}),(0,l.jsx)(e.span,{className:"katex-html","aria-hidden":"true",children:(0,l.jsxs)(e.span,{className:"base",children:[(0,l.jsx)(e.span,{className:"strut",style:{height:"0.6833em"}}),(0,l.jsx)(e.span,{className:"mord mathnormal",style:{marginRight:"0.00773em"},children:"R"})]})})]})," \u4e2a Query \u5934\u3002"]}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.strong,{children:"\u7ec4\u5185\u5171\u4eab\uff1a"})," \u540c\u4e00\u7ec4\u5185\u7684 ",(0,l.jsxs)(e.span,{className:"katex",children:[(0,l.jsx)(e.span,{className:"katex-mathml",children:(0,l.jsx)(e.math,{xmlns:"http://www.w3.org/1998/Math/MathML",children:(0,l.jsxs)(e.semantics,{children:[(0,l.jsx)(e.mrow,{children:(0,l.jsx)(e.mi,{children:"R"})}),(0,l.jsx)(e.annotation,{encoding:"application/x-tex",children:"R"})]})})}),(0,l.jsx)(e.span,{className:"katex-html","aria-hidden":"true",children:(0,l.jsxs)(e.span,{className:"base",children:[(0,l.jsx)(e.span,{className:"strut",style:{height:"0.6833em"}}),(0,l.jsx)(e.span,{className:"mord mathnormal",style:{marginRight:"0.00773em"},children:"R"})]})})]})," \u4e2a Query \u5934\u5171\u4eab\u540c\u4e00\u5bf9 Key \u548c Value \u5934\u3002"]}),"\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.strong,{children:"\u8ba1\u7b97\u903b\u8f91\uff1a"})," \u5728\u8ba1\u7b97 Attention Score \u65f6\uff0c\u9700\u8981\u5c06 Key \u548c Value \u5728\u7ef4\u5ea6\u4e0a\u8fdb\u884c ",(0,l.jsx)(e.strong,{children:"\u5e7f\u64ad (Broadcast)"})," \u6216 ",(0,l.jsx)(e.strong,{children:"\u590d\u5236 (Repeat)"}),"\uff0c\u4ee5\u5339\u914d Query \u7684\u6570\u91cf\u3002"]}),"\n"]}),"\n",(0,l.jsx)(e.p,{children:(0,l.jsx)(e.strong,{children:"\u793a\u4f8b\u914d\u7f6e\uff1a"})}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"Query Heads = 32"}),"\n",(0,l.jsx)(e.li,{children:"KV Heads = 8"}),"\n",(0,l.jsx)(e.li,{children:"\u5206\u7ec4\u5927\u5c0f (Group Size) = 4"}),"\n",(0,l.jsx)(e.li,{children:"\u5373\uff1a\u6bcf 4 \u4e2a Query \u5934\u5171\u7528 1 \u4e2a KV \u5934\u3002"}),"\n"]}),"\n",(0,l.jsx)(e.hr,{}),"\n",(0,l.jsx)(e.h2,{id:"3-\u5b9e\u73b0\u7ec6\u8282-implementation",children:"3. \u5b9e\u73b0\u7ec6\u8282 (Implementation)"}),"\n",(0,l.jsx)(e.p,{children:"\u4ee5\u4e0b\u662f\u57fa\u4e8e PyTorch \u7684\u6807\u51c6 GQA \u6a21\u5757\u5b9e\u73b0\u53c2\u8003\u3002"}),"\n",(0,l.jsx)(e.h3,{id:"31-\u6838\u5fc3\u4ee3\u7801\u903b\u8f91",children:"3.1 \u6838\u5fc3\u4ee3\u7801\u903b\u8f91"}),"\n",(0,l.jsxs)(e.p,{children:["GQA \u7684\u5b9e\u73b0\u4e0e MHA \u975e\u5e38\u76f8\u4f3c\uff0c\u552f\u4e00\u7684\u533a\u522b\u5728\u4e8e ",(0,l.jsx)(e.code,{children:"forward"})," \u8fc7\u7a0b\u4e2d\u5bf9 KV \u5f20\u91cf\u7684\u5904\u7406\u3002"]}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-python",children:'import torch\nimport torch.nn as nn\nimport torch.nn.functional as F\n\ndef repeat_kv(x: torch.Tensor, n_rep: int) -> torch.Tensor:\n    """\n    \u5c06 KV \u5934\u7684\u6570\u636e\u6cbf\u5934\u7ef4\u5ea6\u590d\u5236\uff0c\u4ee5\u5339\u914d Query \u7684\u5934\u6570\u3002\n    input: (Batch, Seq_Len, n_kv_head, Head_Dim)\n    output: (Batch, Seq_Len, n_head, Head_Dim)\n    """\n    if n_rep == 1:\n        return x\n    B, T, n_kv_head, head_dim = x.shape\n    # \u4f7f\u7528 repeat_interleave \u5b9e\u73b0: [k1, k2] -> [k1, k1, k2, k2]\n    return x.repeat_interleave(n_rep, dim=2)\n\nclass GQA(nn.Module):\n    def __init__(self, dim, n_head, n_kv_head):\n        super().__init__()\n        self.n_head = n_head\n        self.n_kv_head = n_kv_head\n        self.n_rep = n_head // n_kv_head\n        self.head_dim = dim // n_head\n\n        # \u7ef4\u5ea6\u68c0\u67e5\n        assert n_head % n_kv_head == 0, "Query heads must be divisible by KV heads"\n\n        self.wq = nn.Linear(dim, n_head * self.head_dim, bias=False)\n        self.wk = nn.Linear(dim, n_kv_head * self.head_dim, bias=False) # \u53c2\u6570\u91cf\u51cf\u5c11\n        self.wv = nn.Linear(dim, n_kv_head * self.head_dim, bias=False) # \u53c2\u6570\u91cf\u51cf\u5c11\n        self.wo = nn.Linear(dim, dim, bias=False)\n\n    def forward(self, x):\n        B, T, C = x.shape\n\n        # 1. \u6295\u5f71\n        q = self.wq(x).view(B, T, self.n_head, self.head_dim)\n        k = self.wk(x).view(B, T, self.n_kv_head, self.head_dim)\n        v = self.wv(x).view(B, T, self.n_kv_head, self.head_dim)\n\n        # 2. \u8fd9\u91cc\u7684 K, V \u9700\u8981\u91cd\u590d\u4ee5\u5339\u914d Q\n        k = repeat_kv(k, self.n_rep)\n        v = repeat_kv(v, self.n_rep)\n\n        # 3. \u540e\u7eed\u8ba1\u7b97\u4e0e\u6807\u51c6 Attention \u4e00\u81f4\n        # Transpose for attention: (B, n_head, T, head_dim)\n        q, k, v = map(lambda t: t.transpose(1, 2), (q, k, v))\n\n        # Attention calculation...\n        # ...\n\n        return output\n'})}),"\n",(0,l.jsx)(e.hr,{}),"\n",(0,l.jsx)(e.h2,{id:"4-\u6027\u80fd\u5206\u6790-performance-analysis",children:"4. \u6027\u80fd\u5206\u6790 (Performance Analysis)"}),"\n",(0,l.jsx)(e.h3,{id:"41-\u663e\u5b58\u5360\u7528-memory-footprint",children:"4.1 \u663e\u5b58\u5360\u7528 (Memory Footprint)"}),"\n",(0,l.jsxs)(e.p,{children:["GQA \u7684\u4e3b\u8981\u4f18\u52bf\u5728\u4e8e\u5bf9 ",(0,l.jsx)(e.strong,{children:"KV Cache"})," \u7684\u538b\u7f29\u3002"]}),"\n",(0,l.jsxs)(e.p,{children:["\u5047\u8bbe\u6a21\u578b\u5c42\u6570\u4e3a ",(0,l.jsxs)(e.span,{className:"katex",children:[(0,l.jsx)(e.span,{className:"katex-mathml",children:(0,l.jsx)(e.math,{xmlns:"http://www.w3.org/1998/Math/MathML",children:(0,l.jsxs)(e.semantics,{children:[(0,l.jsx)(e.mrow,{children:(0,l.jsx)(e.mi,{children:"L"})}),(0,l.jsx)(e.annotation,{encoding:"application/x-tex",children:"L"})]})})}),(0,l.jsx)(e.span,{className:"katex-html","aria-hidden":"true",children:(0,l.jsxs)(e.span,{className:"base",children:[(0,l.jsx)(e.span,{className:"strut",style:{height:"0.6833em"}}),(0,l.jsx)(e.span,{className:"mord mathnormal",children:"L"})]})})]}),"\uff0c\u9690\u85cf\u5c42\u7ef4\u5ea6\u4e3a ",(0,l.jsxs)(e.span,{className:"katex",children:[(0,l.jsx)(e.span,{className:"katex-mathml",children:(0,l.jsx)(e.math,{xmlns:"http://www.w3.org/1998/Math/MathML",children:(0,l.jsxs)(e.semantics,{children:[(0,l.jsx)(e.mrow,{children:(0,l.jsx)(e.mi,{children:"D"})}),(0,l.jsx)(e.annotation,{encoding:"application/x-tex",children:"D"})]})})}),(0,l.jsx)(e.span,{className:"katex-html","aria-hidden":"true",children:(0,l.jsxs)(e.span,{className:"base",children:[(0,l.jsx)(e.span,{className:"strut",style:{height:"0.6833em"}}),(0,l.jsx)(e.span,{className:"mord mathnormal",style:{marginRight:"0.02778em"},children:"D"})]})})]}),"\uff0c\u5e8f\u5217\u957f\u5ea6\u4e3a ",(0,l.jsxs)(e.span,{className:"katex",children:[(0,l.jsx)(e.span,{className:"katex-mathml",children:(0,l.jsx)(e.math,{xmlns:"http://www.w3.org/1998/Math/MathML",children:(0,l.jsxs)(e.semantics,{children:[(0,l.jsx)(e.mrow,{children:(0,l.jsx)(e.mi,{children:"S"})}),(0,l.jsx)(e.annotation,{encoding:"application/x-tex",children:"S"})]})})}),(0,l.jsx)(e.span,{className:"katex-html","aria-hidden":"true",children:(0,l.jsxs)(e.span,{className:"base",children:[(0,l.jsx)(e.span,{className:"strut",style:{height:"0.6833em"}}),(0,l.jsx)(e.span,{className:"mord mathnormal",style:{marginRight:"0.05764em"},children:"S"})]})})]}),"\uff0cBatch\u5927\u5c0f\u4e3a ",(0,l.jsxs)(e.span,{className:"katex",children:[(0,l.jsx)(e.span,{className:"katex-mathml",children:(0,l.jsx)(e.math,{xmlns:"http://www.w3.org/1998/Math/MathML",children:(0,l.jsxs)(e.semantics,{children:[(0,l.jsx)(e.mrow,{children:(0,l.jsx)(e.mi,{children:"B"})}),(0,l.jsx)(e.annotation,{encoding:"application/x-tex",children:"B"})]})})}),(0,l.jsx)(e.span,{className:"katex-html","aria-hidden":"true",children:(0,l.jsxs)(e.span,{className:"base",children:[(0,l.jsx)(e.span,{className:"strut",style:{height:"0.6833em"}}),(0,l.jsx)(e.span,{className:"mord mathnormal",style:{marginRight:"0.05017em"},children:"B"})]})})]}),"\u3002"]}),"\n",(0,l.jsx)(e.p,{children:"KV Cache \u7684\u663e\u5b58\u5360\u7528\u516c\u5f0f\u5927\u81f4\u4e3a\uff1a"}),"\n",(0,l.jsx)(e.span,{className:"katex-display",children:(0,l.jsxs)(e.span,{className:"katex",children:[(0,l.jsx)(e.span,{className:"katex-mathml",children:(0,l.jsx)(e.math,{xmlns:"http://www.w3.org/1998/Math/MathML",display:"block",children:(0,l.jsxs)(e.semantics,{children:[(0,l.jsxs)(e.mrow,{children:[(0,l.jsx)(e.mtext,{children:"Size"}),(0,l.jsx)(e.mo,{children:"="}),(0,l.jsx)(e.mn,{children:"2"}),(0,l.jsx)(e.mo,{children:"\xd7"}),(0,l.jsx)(e.mi,{children:"B"}),(0,l.jsx)(e.mo,{children:"\xd7"}),(0,l.jsx)(e.mi,{children:"S"}),(0,l.jsx)(e.mo,{children:"\xd7"}),(0,l.jsx)(e.mi,{children:"L"}),(0,l.jsx)(e.mo,{children:"\xd7"}),(0,l.jsx)(e.mi,{children:"D"}),(0,l.jsx)(e.mo,{children:"\xd7"}),(0,l.jsxs)(e.mfrac,{children:[(0,l.jsxs)(e.msub,{children:[(0,l.jsx)(e.mi,{children:"N"}),(0,l.jsxs)(e.mrow,{children:[(0,l.jsx)(e.mi,{children:"k"}),(0,l.jsx)(e.mi,{children:"v"})]})]}),(0,l.jsxs)(e.msub,{children:[(0,l.jsx)(e.mi,{children:"N"}),(0,l.jsxs)(e.mrow,{children:[(0,l.jsx)(e.mi,{children:"h"}),(0,l.jsx)(e.mi,{children:"e"}),(0,l.jsx)(e.mi,{children:"a"}),(0,l.jsx)(e.mi,{children:"d"})]})]})]}),(0,l.jsx)(e.mo,{children:"\xd7"}),(0,l.jsx)(e.mtext,{children:"Precision"})]}),(0,l.jsx)(e.annotation,{encoding:"application/x-tex",children:"\\text{Size} = 2 \\times B \\times S \\times L \\times D \\times \\frac{N_{kv}}{N_{head}} \\times \\text{Precision}"})]})})}),(0,l.jsxs)(e.span,{className:"katex-html","aria-hidden":"true",children:[(0,l.jsxs)(e.span,{className:"base",children:[(0,l.jsx)(e.span,{className:"strut",style:{height:"0.6833em"}}),(0,l.jsx)(e.span,{className:"mord text",children:(0,l.jsx)(e.span,{className:"mord",children:"Size"})}),(0,l.jsx)(e.span,{className:"mspace",style:{marginRight:"0.2778em"}}),(0,l.jsx)(e.span,{className:"mrel",children:"="}),(0,l.jsx)(e.span,{className:"mspace",style:{marginRight:"0.2778em"}})]}),(0,l.jsxs)(e.span,{className:"base",children:[(0,l.jsx)(e.span,{className:"strut",style:{height:"0.7278em",verticalAlign:"-0.0833em"}}),(0,l.jsx)(e.span,{className:"mord",children:"2"}),(0,l.jsx)(e.span,{className:"mspace",style:{marginRight:"0.2222em"}}),(0,l.jsx)(e.span,{className:"mbin",children:"\xd7"}),(0,l.jsx)(e.span,{className:"mspace",style:{marginRight:"0.2222em"}})]}),(0,l.jsxs)(e.span,{className:"base",children:[(0,l.jsx)(e.span,{className:"strut",style:{height:"0.7667em",verticalAlign:"-0.0833em"}}),(0,l.jsx)(e.span,{className:"mord mathnormal",style:{marginRight:"0.05017em"},children:"B"}),(0,l.jsx)(e.span,{className:"mspace",style:{marginRight:"0.2222em"}}),(0,l.jsx)(e.span,{className:"mbin",children:"\xd7"}),(0,l.jsx)(e.span,{className:"mspace",style:{marginRight:"0.2222em"}})]}),(0,l.jsxs)(e.span,{className:"base",children:[(0,l.jsx)(e.span,{className:"strut",style:{height:"0.7667em",verticalAlign:"-0.0833em"}}),(0,l.jsx)(e.span,{className:"mord mathnormal",style:{marginRight:"0.05764em"},children:"S"}),(0,l.jsx)(e.span,{className:"mspace",style:{marginRight:"0.2222em"}}),(0,l.jsx)(e.span,{className:"mbin",children:"\xd7"}),(0,l.jsx)(e.span,{className:"mspace",style:{marginRight:"0.2222em"}})]}),(0,l.jsxs)(e.span,{className:"base",children:[(0,l.jsx)(e.span,{className:"strut",style:{height:"0.7667em",verticalAlign:"-0.0833em"}}),(0,l.jsx)(e.span,{className:"mord mathnormal",children:"L"}),(0,l.jsx)(e.span,{className:"mspace",style:{marginRight:"0.2222em"}}),(0,l.jsx)(e.span,{className:"mbin",children:"\xd7"}),(0,l.jsx)(e.span,{className:"mspace",style:{marginRight:"0.2222em"}})]}),(0,l.jsxs)(e.span,{className:"base",children:[(0,l.jsx)(e.span,{className:"strut",style:{height:"0.7667em",verticalAlign:"-0.0833em"}}),(0,l.jsx)(e.span,{className:"mord mathnormal",style:{marginRight:"0.02778em"},children:"D"}),(0,l.jsx)(e.span,{className:"mspace",style:{marginRight:"0.2222em"}}),(0,l.jsx)(e.span,{className:"mbin",children:"\xd7"}),(0,l.jsx)(e.span,{className:"mspace",style:{marginRight:"0.2222em"}})]}),(0,l.jsxs)(e.span,{className:"base",children:[(0,l.jsx)(e.span,{className:"strut",style:{height:"2.1963em",verticalAlign:"-0.836em"}}),(0,l.jsxs)(e.span,{className:"mord",children:[(0,l.jsx)(e.span,{className:"mopen nulldelimiter"}),(0,l.jsx)(e.span,{className:"mfrac",children:(0,l.jsxs)(e.span,{className:"vlist-t vlist-t2",children:[(0,l.jsxs)(e.span,{className:"vlist-r",children:[(0,l.jsxs)(e.span,{className:"vlist",style:{height:"1.3603em"},children:[(0,l.jsxs)(e.span,{style:{top:"-2.314em"},children:[(0,l.jsx)(e.span,{className:"pstrut",style:{height:"3em"}}),(0,l.jsx)(e.span,{className:"mord",children:(0,l.jsxs)(e.span,{className:"mord",children:[(0,l.jsx)(e.span,{className:"mord mathnormal",style:{marginRight:"0.10903em"},children:"N"}),(0,l.jsx)(e.span,{className:"msupsub",children:(0,l.jsxs)(e.span,{className:"vlist-t vlist-t2",children:[(0,l.jsxs)(e.span,{className:"vlist-r",children:[(0,l.jsx)(e.span,{className:"vlist",style:{height:"0.3361em"},children:(0,l.jsxs)(e.span,{style:{top:"-2.55em",marginLeft:"-0.109em",marginRight:"0.05em"},children:[(0,l.jsx)(e.span,{className:"pstrut",style:{height:"2.7em"}}),(0,l.jsx)(e.span,{className:"sizing reset-size6 size3 mtight",children:(0,l.jsxs)(e.span,{className:"mord mtight",children:[(0,l.jsx)(e.span,{className:"mord mathnormal mtight",children:"h"}),(0,l.jsx)(e.span,{className:"mord mathnormal mtight",children:"e"}),(0,l.jsx)(e.span,{className:"mord mathnormal mtight",children:"a"}),(0,l.jsx)(e.span,{className:"mord mathnormal mtight",children:"d"})]})})]})}),(0,l.jsx)(e.span,{className:"vlist-s",children:"\u200b"})]}),(0,l.jsx)(e.span,{className:"vlist-r",children:(0,l.jsx)(e.span,{className:"vlist",style:{height:"0.15em"},children:(0,l.jsx)(e.span,{})})})]})})]})})]}),(0,l.jsxs)(e.span,{style:{top:"-3.23em"},children:[(0,l.jsx)(e.span,{className:"pstrut",style:{height:"3em"}}),(0,l.jsx)(e.span,{className:"frac-line",style:{borderBottomWidth:"0.04em"}})]}),(0,l.jsxs)(e.span,{style:{top:"-3.677em"},children:[(0,l.jsx)(e.span,{className:"pstrut",style:{height:"3em"}}),(0,l.jsx)(e.span,{className:"mord",children:(0,l.jsxs)(e.span,{className:"mord",children:[(0,l.jsx)(e.span,{className:"mord mathnormal",style:{marginRight:"0.10903em"},children:"N"}),(0,l.jsx)(e.span,{className:"msupsub",children:(0,l.jsxs)(e.span,{className:"vlist-t vlist-t2",children:[(0,l.jsxs)(e.span,{className:"vlist-r",children:[(0,l.jsx)(e.span,{className:"vlist",style:{height:"0.3361em"},children:(0,l.jsxs)(e.span,{style:{top:"-2.55em",marginLeft:"-0.109em",marginRight:"0.05em"},children:[(0,l.jsx)(e.span,{className:"pstrut",style:{height:"2.7em"}}),(0,l.jsx)(e.span,{className:"sizing reset-size6 size3 mtight",children:(0,l.jsxs)(e.span,{className:"mord mtight",children:[(0,l.jsx)(e.span,{className:"mord mathnormal mtight",style:{marginRight:"0.03148em"},children:"k"}),(0,l.jsx)(e.span,{className:"mord mathnormal mtight",style:{marginRight:"0.03588em"},children:"v"})]})})]})}),(0,l.jsx)(e.span,{className:"vlist-s",children:"\u200b"})]}),(0,l.jsx)(e.span,{className:"vlist-r",children:(0,l.jsx)(e.span,{className:"vlist",style:{height:"0.15em"},children:(0,l.jsx)(e.span,{})})})]})})]})})]})]}),(0,l.jsx)(e.span,{className:"vlist-s",children:"\u200b"})]}),(0,l.jsx)(e.span,{className:"vlist-r",children:(0,l.jsx)(e.span,{className:"vlist",style:{height:"0.836em"},children:(0,l.jsx)(e.span,{})})})]})}),(0,l.jsx)(e.span,{className:"mclose nulldelimiter"})]}),(0,l.jsx)(e.span,{className:"mspace",style:{marginRight:"0.2222em"}}),(0,l.jsx)(e.span,{className:"mbin",children:"\xd7"}),(0,l.jsx)(e.span,{className:"mspace",style:{marginRight:"0.2222em"}})]}),(0,l.jsxs)(e.span,{className:"base",children:[(0,l.jsx)(e.span,{className:"strut",style:{height:"0.6833em"}}),(0,l.jsx)(e.span,{className:"mord text",children:(0,l.jsx)(e.span,{className:"mord",children:"Precision"})})]})]})]})}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsxs)(e.li,{children:["\u5982\u679c\u4f7f\u7528 ",(0,l.jsx)(e.strong,{children:"MHA"})," (",(0,l.jsxs)(e.span,{className:"katex",children:[(0,l.jsx)(e.span,{className:"katex-mathml",children:(0,l.jsx)(e.math,{xmlns:"http://www.w3.org/1998/Math/MathML",children:(0,l.jsxs)(e.semantics,{children:[(0,l.jsxs)(e.mrow,{children:[(0,l.jsxs)(e.msub,{children:[(0,l.jsx)(e.mi,{children:"N"}),(0,l.jsxs)(e.mrow,{children:[(0,l.jsx)(e.mi,{children:"k"}),(0,l.jsx)(e.mi,{children:"v"})]})]}),(0,l.jsx)(e.mo,{children:"="}),(0,l.jsxs)(e.msub,{children:[(0,l.jsx)(e.mi,{children:"N"}),(0,l.jsxs)(e.mrow,{children:[(0,l.jsx)(e.mi,{children:"h"}),(0,l.jsx)(e.mi,{children:"e"}),(0,l.jsx)(e.mi,{children:"a"}),(0,l.jsx)(e.mi,{children:"d"})]})]})]}),(0,l.jsx)(e.annotation,{encoding:"application/x-tex",children:"N_{kv} = N_{head}"})]})})}),(0,l.jsxs)(e.span,{className:"katex-html","aria-hidden":"true",children:[(0,l.jsxs)(e.span,{className:"base",children:[(0,l.jsx)(e.span,{className:"strut",style:{height:"0.8333em",verticalAlign:"-0.15em"}}),(0,l.jsxs)(e.span,{className:"mord",children:[(0,l.jsx)(e.span,{className:"mord mathnormal",style:{marginRight:"0.10903em"},children:"N"}),(0,l.jsx)(e.span,{className:"msupsub",children:(0,l.jsxs)(e.span,{className:"vlist-t vlist-t2",children:[(0,l.jsxs)(e.span,{className:"vlist-r",children:[(0,l.jsx)(e.span,{className:"vlist",style:{height:"0.3361em"},children:(0,l.jsxs)(e.span,{style:{top:"-2.55em",marginLeft:"-0.109em",marginRight:"0.05em"},children:[(0,l.jsx)(e.span,{className:"pstrut",style:{height:"2.7em"}}),(0,l.jsx)(e.span,{className:"sizing reset-size6 size3 mtight",children:(0,l.jsxs)(e.span,{className:"mord mtight",children:[(0,l.jsx)(e.span,{className:"mord mathnormal mtight",style:{marginRight:"0.03148em"},children:"k"}),(0,l.jsx)(e.span,{className:"mord mathnormal mtight",style:{marginRight:"0.03588em"},children:"v"})]})})]})}),(0,l.jsx)(e.span,{className:"vlist-s",children:"\u200b"})]}),(0,l.jsx)(e.span,{className:"vlist-r",children:(0,l.jsx)(e.span,{className:"vlist",style:{height:"0.15em"},children:(0,l.jsx)(e.span,{})})})]})})]}),(0,l.jsx)(e.span,{className:"mspace",style:{marginRight:"0.2778em"}}),(0,l.jsx)(e.span,{className:"mrel",children:"="}),(0,l.jsx)(e.span,{className:"mspace",style:{marginRight:"0.2778em"}})]}),(0,l.jsxs)(e.span,{className:"base",children:[(0,l.jsx)(e.span,{className:"strut",style:{height:"0.8333em",verticalAlign:"-0.15em"}}),(0,l.jsxs)(e.span,{className:"mord",children:[(0,l.jsx)(e.span,{className:"mord mathnormal",style:{marginRight:"0.10903em"},children:"N"}),(0,l.jsx)(e.span,{className:"msupsub",children:(0,l.jsxs)(e.span,{className:"vlist-t vlist-t2",children:[(0,l.jsxs)(e.span,{className:"vlist-r",children:[(0,l.jsx)(e.span,{className:"vlist",style:{height:"0.3361em"},children:(0,l.jsxs)(e.span,{style:{top:"-2.55em",marginLeft:"-0.109em",marginRight:"0.05em"},children:[(0,l.jsx)(e.span,{className:"pstrut",style:{height:"2.7em"}}),(0,l.jsx)(e.span,{className:"sizing reset-size6 size3 mtight",children:(0,l.jsxs)(e.span,{className:"mord mtight",children:[(0,l.jsx)(e.span,{className:"mord mathnormal mtight",children:"h"}),(0,l.jsx)(e.span,{className:"mord mathnormal mtight",children:"e"}),(0,l.jsx)(e.span,{className:"mord mathnormal mtight",children:"a"}),(0,l.jsx)(e.span,{className:"mord mathnormal mtight",children:"d"})]})})]})}),(0,l.jsx)(e.span,{className:"vlist-s",children:"\u200b"})]}),(0,l.jsx)(e.span,{className:"vlist-r",children:(0,l.jsx)(e.span,{className:"vlist",style:{height:"0.15em"},children:(0,l.jsx)(e.span,{})})})]})})]})]})]})]}),")\uff0c\u7cfb\u6570\u4e3a 1\u3002"]}),"\n",(0,l.jsxs)(e.li,{children:["\u5982\u679c\u4f7f\u7528 ",(0,l.jsx)(e.strong,{children:"GQA"})," (",(0,l.jsxs)(e.span,{className:"katex",children:[(0,l.jsx)(e.span,{className:"katex-mathml",children:(0,l.jsx)(e.math,{xmlns:"http://www.w3.org/1998/Math/MathML",children:(0,l.jsxs)(e.semantics,{children:[(0,l.jsxs)(e.mrow,{children:[(0,l.jsxs)(e.msub,{children:[(0,l.jsx)(e.mi,{children:"N"}),(0,l.jsxs)(e.mrow,{children:[(0,l.jsx)(e.mi,{children:"k"}),(0,l.jsx)(e.mi,{children:"v"})]})]}),(0,l.jsx)(e.mo,{children:"="}),(0,l.jsxs)(e.mfrac,{children:[(0,l.jsx)(e.mn,{children:"1"}),(0,l.jsx)(e.mn,{children:"8"})]}),(0,l.jsxs)(e.msub,{children:[(0,l.jsx)(e.mi,{children:"N"}),(0,l.jsxs)(e.mrow,{children:[(0,l.jsx)(e.mi,{children:"h"}),(0,l.jsx)(e.mi,{children:"e"}),(0,l.jsx)(e.mi,{children:"a"}),(0,l.jsx)(e.mi,{children:"d"})]})]})]}),(0,l.jsx)(e.annotation,{encoding:"application/x-tex",children:"N_{kv} = \\frac{1}{8} N_{head}"})]})})}),(0,l.jsxs)(e.span,{className:"katex-html","aria-hidden":"true",children:[(0,l.jsxs)(e.span,{className:"base",children:[(0,l.jsx)(e.span,{className:"strut",style:{height:"0.8333em",verticalAlign:"-0.15em"}}),(0,l.jsxs)(e.span,{className:"mord",children:[(0,l.jsx)(e.span,{className:"mord mathnormal",style:{marginRight:"0.10903em"},children:"N"}),(0,l.jsx)(e.span,{className:"msupsub",children:(0,l.jsxs)(e.span,{className:"vlist-t vlist-t2",children:[(0,l.jsxs)(e.span,{className:"vlist-r",children:[(0,l.jsx)(e.span,{className:"vlist",style:{height:"0.3361em"},children:(0,l.jsxs)(e.span,{style:{top:"-2.55em",marginLeft:"-0.109em",marginRight:"0.05em"},children:[(0,l.jsx)(e.span,{className:"pstrut",style:{height:"2.7em"}}),(0,l.jsx)(e.span,{className:"sizing reset-size6 size3 mtight",children:(0,l.jsxs)(e.span,{className:"mord mtight",children:[(0,l.jsx)(e.span,{className:"mord mathnormal mtight",style:{marginRight:"0.03148em"},children:"k"}),(0,l.jsx)(e.span,{className:"mord mathnormal mtight",style:{marginRight:"0.03588em"},children:"v"})]})})]})}),(0,l.jsx)(e.span,{className:"vlist-s",children:"\u200b"})]}),(0,l.jsx)(e.span,{className:"vlist-r",children:(0,l.jsx)(e.span,{className:"vlist",style:{height:"0.15em"},children:(0,l.jsx)(e.span,{})})})]})})]}),(0,l.jsx)(e.span,{className:"mspace",style:{marginRight:"0.2778em"}}),(0,l.jsx)(e.span,{className:"mrel",children:"="}),(0,l.jsx)(e.span,{className:"mspace",style:{marginRight:"0.2778em"}})]}),(0,l.jsxs)(e.span,{className:"base",children:[(0,l.jsx)(e.span,{className:"strut",style:{height:"1.1901em",verticalAlign:"-0.345em"}}),(0,l.jsxs)(e.span,{className:"mord",children:[(0,l.jsx)(e.span,{className:"mopen nulldelimiter"}),(0,l.jsx)(e.span,{className:"mfrac",children:(0,l.jsxs)(e.span,{className:"vlist-t vlist-t2",children:[(0,l.jsxs)(e.span,{className:"vlist-r",children:[(0,l.jsxs)(e.span,{className:"vlist",style:{height:"0.8451em"},children:[(0,l.jsxs)(e.span,{style:{top:"-2.655em"},children:[(0,l.jsx)(e.span,{className:"pstrut",style:{height:"3em"}}),(0,l.jsx)(e.span,{className:"sizing reset-size6 size3 mtight",children:(0,l.jsx)(e.span,{className:"mord mtight",children:(0,l.jsx)(e.span,{className:"mord mtight",children:"8"})})})]}),(0,l.jsxs)(e.span,{style:{top:"-3.23em"},children:[(0,l.jsx)(e.span,{className:"pstrut",style:{height:"3em"}}),(0,l.jsx)(e.span,{className:"frac-line",style:{borderBottomWidth:"0.04em"}})]}),(0,l.jsxs)(e.span,{style:{top:"-3.394em"},children:[(0,l.jsx)(e.span,{className:"pstrut",style:{height:"3em"}}),(0,l.jsx)(e.span,{className:"sizing reset-size6 size3 mtight",children:(0,l.jsx)(e.span,{className:"mord mtight",children:(0,l.jsx)(e.span,{className:"mord mtight",children:"1"})})})]})]}),(0,l.jsx)(e.span,{className:"vlist-s",children:"\u200b"})]}),(0,l.jsx)(e.span,{className:"vlist-r",children:(0,l.jsx)(e.span,{className:"vlist",style:{height:"0.345em"},children:(0,l.jsx)(e.span,{})})})]})}),(0,l.jsx)(e.span,{className:"mclose nulldelimiter"})]}),(0,l.jsxs)(e.span,{className:"mord",children:[(0,l.jsx)(e.span,{className:"mord mathnormal",style:{marginRight:"0.10903em"},children:"N"}),(0,l.jsx)(e.span,{className:"msupsub",children:(0,l.jsxs)(e.span,{className:"vlist-t vlist-t2",children:[(0,l.jsxs)(e.span,{className:"vlist-r",children:[(0,l.jsx)(e.span,{className:"vlist",style:{height:"0.3361em"},children:(0,l.jsxs)(e.span,{style:{top:"-2.55em",marginLeft:"-0.109em",marginRight:"0.05em"},children:[(0,l.jsx)(e.span,{className:"pstrut",style:{height:"2.7em"}}),(0,l.jsx)(e.span,{className:"sizing reset-size6 size3 mtight",children:(0,l.jsxs)(e.span,{className:"mord mtight",children:[(0,l.jsx)(e.span,{className:"mord mathnormal mtight",children:"h"}),(0,l.jsx)(e.span,{className:"mord mathnormal mtight",children:"e"}),(0,l.jsx)(e.span,{className:"mord mathnormal mtight",children:"a"}),(0,l.jsx)(e.span,{className:"mord mathnormal mtight",children:"d"})]})})]})}),(0,l.jsx)(e.span,{className:"vlist-s",children:"\u200b"})]}),(0,l.jsx)(e.span,{className:"vlist-r",children:(0,l.jsx)(e.span,{className:"vlist",style:{height:"0.15em"},children:(0,l.jsx)(e.span,{})})})]})})]})]})]})]}),")\uff0c\u7cfb\u6570\u4e3a 1/8\u3002"]}),"\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.strong,{children:"\u7ed3\u8bba\uff1a"})," GQA \u80fd\u8ba9\u540c\u6837\u7684\u663e\u5361\u652f\u6301 ",(0,l.jsx)(e.strong,{children:"8\u500d"})," \u7684 Batch Size \u6216 ",(0,l.jsx)(e.strong,{children:"8\u500d"})," \u7684 Context Length\u3002"]}),"\n"]}),"\n",(0,l.jsx)(e.h3,{id:"42-\u7cbe\u5ea6\u5f71\u54cd-accuracy",children:"4.2 \u7cbe\u5ea6\u5f71\u54cd (Accuracy)"}),"\n",(0,l.jsx)(e.p,{children:"\u6839\u636e Llama 2 \u548c\u5176\u4ed6\u6d88\u878d\u5b9e\u9a8c\u7684\u7ed3\u679c\uff1a"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.strong,{children:"MHA vs GQA:"})," GQA \u7684 Perplexity (\u56f0\u60d1\u5ea6) \u4ec5\u6bd4 MHA \u589e\u52a0\u5fae\u4e0d\u8db3\u9053\u7684\u6570\u503c\uff08\u4f8b\u5982 +0.01\uff09\uff0c\u5728\u4e0b\u6e38\u4efb\u52a1\uff08Summarization, QA\uff09\u4e2d\u8868\u73b0\u51e0\u4e4e\u4e00\u81f4\u3002"]}),"\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.strong,{children:"GQA vs MQA:"})," GQA \u5728\u591a\u6b65\u63a8\u7406\u548c\u590d\u6742\u903b\u8f91\u4efb\u52a1\u4e0a\u663e\u8457\u4f18\u4e8e MQA\u3002"]}),"\n"]}),"\n",(0,l.jsx)(e.hr,{}),"\n",(0,l.jsx)(e.h2,{id:"5-\u6700\u4f73\u5b9e\u8df5\u4e0e\u914d\u7f6e-best-practices",children:"5. \u6700\u4f73\u5b9e\u8df5\u4e0e\u914d\u7f6e (Best Practices)"}),"\n",(0,l.jsx)(e.h3,{id:"51-\u53c2\u6570\u9009\u62e9",children:"5.1 \u53c2\u6570\u9009\u62e9"}),"\n",(0,l.jsx)(e.p,{children:"\u5728\u8bbe\u8ba1\u65b0\u6a21\u578b\u6216\u8fdb\u884c Uptraining \u65f6\uff0c\u63a8\u8350\u4ee5\u4e0b\u914d\u7f6e\uff1a"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.strong,{children:"Group Size (\u5206\u7ec4\u5927\u5c0f):"})," \u901a\u5e38\u5efa\u8bae\u8bbe\u7f6e\u4e3a ",(0,l.jsx)(e.strong,{children:"8"})," (\u5373 ",(0,l.jsx)(e.code,{children:"n_head"})," \u662f ",(0,l.jsx)(e.code,{children:"n_kv_head"})," \u7684 8 \u500d)\u3002\u8fd9\u662f\u76ee\u524d\u4e1a\u754c\uff08\u5982 Llama 3\uff09\u516c\u8ba4\u7684\u6027\u4ef7\u6bd4\u751c\u70b9\u3002"]}),"\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.strong,{children:"Uptraining:"})," \u5982\u679c\u4ece\u73b0\u6709\u7684 MHA \u6a21\u578b\u8f6c\u6362\uff0c\u9700\u8981\u8fdb\u884c\u7ea6\u539f\u59cb\u9884\u8bad\u7ec3\u6b65\u6570 5% \u7684\u7ee7\u7eed\u8bad\u7ec3\uff08Uptraining\uff09\uff0c\u4ee5\u4f7f\u6a21\u578b\u9002\u5e94\u5171\u4eab KV \u7684\u6a21\u5f0f\u3002"]}),"\n"]}),"\n",(0,l.jsx)(e.h3,{id:"52-\u5e38\u89c1\u5f00\u6e90\u6a21\u578b\u6848\u4f8b",children:"5.2 \u5e38\u89c1\u5f00\u6e90\u6a21\u578b\u6848\u4f8b"}),"\n",(0,l.jsx)(e.p,{children:"\u76ee\u524d\u4e3b\u6d41\u6a21\u578b\u5747\u5df2\u91c7\u7528 GQA\uff1a"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.strong,{children:"Llama 2 (70B):"})," GQA"]}),"\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.strong,{children:"Llama 3 (8B & 70B):"})," GQA"]}),"\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.strong,{children:"Mistral 7B:"})," GQA"]}),"\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.strong,{children:"Qwen-2:"})," GQA"]}),"\n"]}),"\n",(0,l.jsx)(e.hr,{}),"\n",(0,l.jsx)(e.h2,{id:"6-\u5e38\u89c1\u95ee\u9898-faq",children:"6. \u5e38\u89c1\u95ee\u9898 (FAQ)"}),"\n",(0,l.jsx)(e.p,{children:(0,l.jsx)(e.strong,{children:"Q: \u4f7f\u7528 GQA \u4f1a\u5bfc\u81f4\u9996\u5b57\u5ef6\u8fdf\uff08Time to First Token\uff09\u53d8\u6162\u5417\uff1f"})}),"\n",(0,l.jsx)(e.p,{children:"A: \u4e0d\u4f1a\u3002\u9996\u5b57\u751f\u6210\u4e3b\u8981\u53d7\u9650\u4e8e\u77e9\u9635\u4e58\u6cd5\u8ba1\u7b97\u91cf\uff08Compute Bound\uff09\uff0cGQA \u7684\u8ba1\u7b97\u91cf\u4e0e MHA \u76f8\u6bd4\u4ec5\u7565\u5fae\u51cf\u5c11\uff08\u56e0\u4e3a Projection \u5c42\u53d8\u5c0f\uff09\uff0c\u6240\u4ee5\u9996\u5b57\u5ef6\u8fdf\u51e0\u4e4e\u6301\u5e73\u3002GQA \u63d0\u5347\u7684\u662f\u540e\u7eed\u751f\u6210\u7684\u541e\u5410\u91cf\uff08Memory Bound\uff09\u3002"}),"\n",(0,l.jsx)(e.p,{children:(0,l.jsx)(e.strong,{children:"Q: \u6211\u53ef\u4ee5\u76f4\u63a5\u4fee\u6539\u63a8\u7406\u4ee3\u7801\u6765\u628a MHA \u53d8\u6210 GQA \u5417\uff1f"})}),"\n",(0,l.jsx)(e.p,{children:"A: \u4e0d\u53ef\u4ee5\u3002\u6a21\u578b\u7684\u6743\u91cd\uff08Weights\uff09\u5fc5\u987b\u5728\u8bad\u7ec3\u9636\u6bb5\u5c31\u6309\u7167 GQA \u7684\u7ed3\u6784\u8fdb\u884c\u8bad\u7ec3\u3002\u4f60\u4e0d\u80fd\u76f4\u63a5\u628a\u8bad\u7ec3\u597d\u7684 MHA \u6743\u91cd\u7684 KV \u5934\u5e73\u5747\u5316\uff0c\u90a3\u6837\u4f1a\u5bfc\u81f4\u6a21\u578b\u8f93\u51fa\u4e71\u7801\u3002"}),"\n",(0,l.jsx)(e.hr,{}),"\n",(0,l.jsx)(e.h2,{id:"7-\u53c2\u8003\u8d44\u6599",children:"7. \u53c2\u8003\u8d44\u6599"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.a,{href:"https://arxiv.org/abs/2305.13245",children:"GQA: Training Generalized Multi-Query Transformer Models"})," - GQA \u539f\u59cb\u8bba\u6587"]}),"\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.a,{href:"https://arxiv.org/abs/2307.09288",children:"Llama 2: Open Foundation and Fine-Tuned Chat Models"})," - Llama 2 \u6280\u672f\u62a5\u544a"]}),"\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.a,{href:"https://arxiv.org/abs/1911.02150",children:"Fast Transformer Decoding: One Write-Head is All You Need"})," - MQA \u539f\u59cb\u8bba\u6587"]}),"\n"]})]})}function d(s={}){const{wrapper:e}={...(0,i.R)(),...s.components};return e?(0,l.jsx)(e,{...s,children:(0,l.jsx)(h,{...s})}):h(s)}}}]);