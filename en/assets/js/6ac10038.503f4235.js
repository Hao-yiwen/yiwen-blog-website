"use strict";(globalThis.webpackChunkyiwen_blog_website=globalThis.webpackChunkyiwen_blog_website||[]).push([[66713],{28453(e,n,i){i.d(n,{R:()=>t,x:()=>d});var s=i(96540);const l={},r=s.createContext(l);function t(e){const n=s.useContext(r);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function d(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(l):e.components||l:t(e.components),s.createElement(r.Provider,{value:n},e.children)}},73323(e,n,i){i.r(n),i.d(n,{assets:()=>a,contentTitle:()=>d,default:()=>h,frontMatter:()=>t,metadata:()=>s,toc:()=>o});const s=JSON.parse('{"id":"backend/devops/jenkins-pipeline","title":"Pipeline \u5f00\u53d1\u4e0e\u6267\u884c\u673a\u5236","description":"1. \u63d2\u4ef6 vs \u5de5\u5177","source":"@site/docs/backend/devops/jenkins-pipeline.md","sourceDirName":"backend/devops","slug":"/backend/devops/jenkins-pipeline","permalink":"/yiwen-blog-website/en/docs/backend/devops/jenkins-pipeline","draft":false,"unlisted":false,"editUrl":"https://github.com/Hao-yiwen/yiwen-blog-website/tree/master/docs/backend/devops/jenkins-pipeline.md","tags":[{"inline":true,"label":"jenkins","permalink":"/yiwen-blog-website/en/docs/tags/jenkins"},{"inline":true,"label":"pipeline","permalink":"/yiwen-blog-website/en/docs/tags/pipeline"},{"inline":true,"label":"groovy","permalink":"/yiwen-blog-website/en/docs/tags/groovy"},{"inline":true,"label":"ci","permalink":"/yiwen-blog-website/en/docs/tags/ci"}],"version":"current","lastUpdatedAt":1768988229000,"sidebarPosition":2,"frontMatter":{"title":"Pipeline \u5f00\u53d1\u4e0e\u6267\u884c\u673a\u5236","sidebar_position":2,"tags":["jenkins","pipeline","groovy","ci"]},"sidebar":"backendSidebar","previous":{"title":"Jenkins \u57fa\u7840\u67b6\u6784\u4e0e\u5bb9\u5668\u5316\u90e8\u7f72","permalink":"/yiwen-blog-website/en/docs/backend/devops/jenkins-architecture"},"next":{"title":"Jenkins \u4e0e Kubernetes \u7684\u6df1\u5ea6\u96c6\u6210","permalink":"/yiwen-blog-website/en/docs/backend/devops/jenkins-kubernetes"}}');var l=i(74848),r=i(28453);const t={title:"Pipeline \u5f00\u53d1\u4e0e\u6267\u884c\u673a\u5236",sidebar_position:2,tags:["jenkins","pipeline","groovy","ci"]},d="Pipeline \u5f00\u53d1\u4e0e\u6267\u884c\u673a\u5236",a={},o=[{value:"1. \u63d2\u4ef6 vs \u5de5\u5177",id:"1-\u63d2\u4ef6-vs-\u5de5\u5177",level:2},{value:"2. Jenkinsfile \u6a21\u677f (\u58f0\u660e\u5f0f\u6d41\u6c34\u7ebf)",id:"2-jenkinsfile-\u6a21\u677f-\u58f0\u660e\u5f0f\u6d41\u6c34\u7ebf",level:2},{value:"2.1 \u57fa\u7840\u6a21\u677f",id:"21-\u57fa\u7840\u6a21\u677f",level:3},{value:"2.2 \u5e26\u53c2\u6570\u7684\u6d41\u6c34\u7ebf",id:"22-\u5e26\u53c2\u6570\u7684\u6d41\u6c34\u7ebf",level:3},{value:"3. \u89e6\u53d1\u65b9\u5f0f",id:"3-\u89e6\u53d1\u65b9\u5f0f",level:2},{value:"3.1 Webhook (\u63a8\u8350)",id:"31-webhook-\u63a8\u8350",level:3},{value:"3.2 Cron \u5b9a\u65f6\u4efb\u52a1",id:"32-cron-\u5b9a\u65f6\u4efb\u52a1",level:3},{value:"3.3 \u8f6e\u8be2 SCM (\u4e0d\u63a8\u8350)",id:"33-\u8f6e\u8be2-scm-\u4e0d\u63a8\u8350",level:3},{value:"4. \u5e38\u7528 Pipeline \u8bed\u6cd5",id:"4-\u5e38\u7528-pipeline-\u8bed\u6cd5",level:2},{value:"4.1 \u6761\u4ef6\u6267\u884c",id:"41-\u6761\u4ef6\u6267\u884c",level:3},{value:"4.2 \u5e76\u884c\u6267\u884c",id:"42-\u5e76\u884c\u6267\u884c",level:3},{value:"4.3 \u9519\u8bef\u5904\u7406",id:"43-\u9519\u8bef\u5904\u7406",level:3},{value:"4.4 \u8f93\u5165\u786e\u8ba4",id:"44-\u8f93\u5165\u786e\u8ba4",level:3},{value:"5. \u6700\u4f73\u5b9e\u8df5",id:"5-\u6700\u4f73\u5b9e\u8df5",level:2},{value:"5.1 Jenkinsfile \u5b58\u653e\u4f4d\u7f6e",id:"51-jenkinsfile-\u5b58\u653e\u4f4d\u7f6e",level:3},{value:"5.2 \u5171\u4eab\u5e93",id:"52-\u5171\u4eab\u5e93",level:3},{value:"5.3 \u51ed\u636e\u7ba1\u7406",id:"53-\u51ed\u636e\u7ba1\u7406",level:3}];function c(e){const n={admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",...(0,r.R)(),...e.components};return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(n.header,{children:(0,l.jsx)(n.h1,{id:"pipeline-\u5f00\u53d1\u4e0e\u6267\u884c\u673a\u5236",children:"Pipeline \u5f00\u53d1\u4e0e\u6267\u884c\u673a\u5236"})}),"\n",(0,l.jsx)(n.h2,{id:"1-\u63d2\u4ef6-vs-\u5de5\u5177",children:"1. \u63d2\u4ef6 vs \u5de5\u5177"}),"\n",(0,l.jsx)(n.p,{children:"\u7406\u89e3 Jenkins \u4e2d\u63d2\u4ef6\u548c\u5de5\u5177\u7684\u533a\u522b\u81f3\u5173\u91cd\u8981\uff1a"}),"\n",(0,l.jsxs)(n.table,{children:[(0,l.jsx)(n.thead,{children:(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.th,{children:"\u7c7b\u578b"}),(0,l.jsx)(n.th,{children:"\u89d2\u8272"}),(0,l.jsx)(n.th,{children:"\u793a\u4f8b"})]})}),(0,l.jsxs)(n.tbody,{children:[(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:(0,l.jsx)(n.strong,{children:"\u63d2\u4ef6 (Plugins)"})}),(0,l.jsx)(n.td,{children:'"\u6307\u6325\u5b98"\uff0c\u8d1f\u8d23\u903b\u8f91\u63a7\u5236'}),(0,l.jsx)(n.td,{children:"Git \u63d2\u4ef6\u3001Pipeline \u63d2\u4ef6\u3001Docker Pipeline \u63d2\u4ef6"})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:(0,l.jsx)(n.strong,{children:"\u5de5\u5177 (Tools)"})}),(0,l.jsx)(n.td,{children:'"\u5e72\u82e6\u529b\u7684"\uff0c\u5b9e\u9645\u6267\u884c\u547d\u4ee4'}),(0,l.jsxs)(n.td,{children:[(0,l.jsx)(n.code,{children:"mvn"}),", ",(0,l.jsx)(n.code,{children:"npm"}),", ",(0,l.jsx)(n.code,{children:"docker"}),", ",(0,l.jsx)(n.code,{children:"kubectl"})]})]})]})]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.strong,{children:"\u5173\u952e\u70b9\uff1a"})," \u5fc5\u987b\u786e\u4fdd Jenkins \u8fd0\u884c\u7684\u8282\u70b9\uff08\u6216\u955c\u50cf\uff09\u91cc\u5b89\u88c5\u4e86\u8fd9\u4e9b\u5de5\u5177\uff0c\u5426\u5219\u4f1a\u62a5 ",(0,l.jsx)(n.code,{children:"command not found"}),"\u3002"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{children:'\u63d2\u4ef6\uff1a\u77e5\u9053"\u600e\u4e48\u505a" (HOW)\n\u5de5\u5177\uff1a\u5b9e\u9645"\u53bb\u505a"   (DO)\n'})}),"\n",(0,l.jsx)(n.h2,{id:"2-jenkinsfile-\u6a21\u677f-\u58f0\u660e\u5f0f\u6d41\u6c34\u7ebf",children:"2. Jenkinsfile \u6a21\u677f (\u58f0\u660e\u5f0f\u6d41\u6c34\u7ebf)"}),"\n",(0,l.jsx)(n.p,{children:"\u58f0\u660e\u5f0f\u6d41\u6c34\u7ebf\u662f\u6700\u4e3b\u6d41\u7684\u5199\u6cd5\uff0c\u7ed3\u6784\u6e05\u6670\uff0c\u6613\u4e8e\u7ef4\u62a4\u3002"}),"\n",(0,l.jsx)(n.h3,{id:"21-\u57fa\u7840\u6a21\u677f",children:"2.1 \u57fa\u7840\u6a21\u677f"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-groovy",children:"pipeline {\n    agent any // \u6216\u6307\u5b9a kubernetes\n\n    options {\n        ansiColor('xterm')      // \u5f00\u542f\u5f69\u8272\u65e5\u5fd7\n        timestamps()            // \u5f00\u542f\u65f6\u95f4\u6233\n        timeout(time: 30, unit: 'MINUTES') // \u8d85\u65f6\u8bbe\u7f6e\n        disableConcurrentBuilds()          // \u7981\u6b62\u5e76\u53d1\u6784\u5efa\n    }\n\n    environment {\n        APP_NAME = 'my-app'\n        REGISTRY = 'harbor.example.com'\n    }\n\n    stages {\n        stage('Checkout') {\n            steps {\n                checkout scm\n            }\n        }\n\n        stage('Build & Test') {\n            steps {\n                sh 'echo \"\u5f00\u59cb\u7f16\u8bd1...\"'\n                sh 'mvn clean package -DskipTests=false'\n            }\n        }\n\n        stage('Docker Build') {\n            steps {\n                sh \"docker build -t ${REGISTRY}/${APP_NAME}:${BUILD_NUMBER} .\"\n            }\n        }\n\n        stage('Push Image') {\n            steps {\n                withCredentials([usernamePassword(\n                    credentialsId: 'harbor-credentials',\n                    usernameVariable: 'DOCKER_USER',\n                    passwordVariable: 'DOCKER_PASS'\n                )]) {\n                    sh '''\n                        echo $DOCKER_PASS | docker login ${REGISTRY} -u $DOCKER_USER --password-stdin\n                        docker push ${REGISTRY}/${APP_NAME}:${BUILD_NUMBER}\n                    '''\n                }\n            }\n        }\n    }\n\n    post {\n        success {\n            echo '\u6784\u5efa\u6210\u529f\uff01'\n        }\n        failure {\n            echo '\u6784\u5efa\u5931\u8d25\uff01'\n        }\n        always {\n            cleanWs() // \u6e05\u7406\u5de5\u4f5c\u7a7a\u95f4\n        }\n    }\n}\n"})}),"\n",(0,l.jsx)(n.h3,{id:"22-\u5e26\u53c2\u6570\u7684\u6d41\u6c34\u7ebf",children:"2.2 \u5e26\u53c2\u6570\u7684\u6d41\u6c34\u7ebf"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-groovy",children:"pipeline {\n    agent any\n\n    parameters {\n        string(name: 'BRANCH', defaultValue: 'main', description: '\u8981\u6784\u5efa\u7684\u5206\u652f')\n        choice(name: 'ENV', choices: ['dev', 'staging', 'prod'], description: '\u90e8\u7f72\u73af\u5883')\n        booleanParam(name: 'SKIP_TESTS', defaultValue: false, description: '\u662f\u5426\u8df3\u8fc7\u6d4b\u8bd5')\n    }\n\n    stages {\n        stage('Info') {\n            steps {\n                echo \"\u6784\u5efa\u5206\u652f: ${params.BRANCH}\"\n                echo \"\u90e8\u7f72\u73af\u5883: ${params.ENV}\"\n            }\n        }\n\n        stage('Test') {\n            when {\n                expression { return !params.SKIP_TESTS }\n            }\n            steps {\n                sh 'mvn test'\n            }\n        }\n    }\n}\n"})}),"\n",(0,l.jsx)(n.h2,{id:"3-\u89e6\u53d1\u65b9\u5f0f",children:"3. \u89e6\u53d1\u65b9\u5f0f"}),"\n",(0,l.jsx)(n.h3,{id:"31-webhook-\u63a8\u8350",children:"3.1 Webhook (\u63a8\u8350)"}),"\n",(0,l.jsx)(n.p,{children:"Git \u63d0\u4ea4\u4ee3\u7801 \u2192 \u5b9e\u65f6\u901a\u77e5 Jenkins \u2192 \u7acb\u5373\u6784\u5efa\u3002"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-groovy",children:"pipeline {\n    triggers {\n        // GitHub Webhook\n        githubPush()\n\n        // GitLab Webhook\n        gitlab(triggerOnPush: true, triggerOnMergeRequest: true)\n    }\n    // ...\n}\n"})}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.strong,{children:"\u914d\u7f6e\u6b65\u9aa4\uff1a"})}),"\n",(0,l.jsxs)(n.ol,{children:["\n",(0,l.jsx)(n.li,{children:"\u5728 Jenkins \u4e2d\u914d\u7f6e Git \u4ed3\u5e93\u5730\u5740"}),"\n",(0,l.jsxs)(n.li,{children:["\u5728 Git \u5e73\u53f0\u914d\u7f6e Webhook URL: ",(0,l.jsx)(n.code,{children:"http://jenkins-url/github-webhook/"})]}),"\n",(0,l.jsx)(n.li,{children:"\u9009\u62e9\u89e6\u53d1\u4e8b\u4ef6\uff08Push\u3001Pull Request \u7b49\uff09"}),"\n"]}),"\n",(0,l.jsx)(n.h3,{id:"32-cron-\u5b9a\u65f6\u4efb\u52a1",children:"3.2 Cron \u5b9a\u65f6\u4efb\u52a1"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-groovy",children:"pipeline {\n    triggers {\n        // \u6bcf\u5929\u51cc\u6668 2 \u70b9\u6784\u5efa\n        cron('0 2 * * *')\n\n        // \u5de5\u4f5c\u65e5\u6bcf\u9694 2 \u5c0f\u65f6\u6784\u5efa\n        cron('0 */2 * * 1-5')\n    }\n    // ...\n}\n"})}),"\n",(0,l.jsx)(n.h3,{id:"33-\u8f6e\u8be2-scm-\u4e0d\u63a8\u8350",children:"3.3 \u8f6e\u8be2 SCM (\u4e0d\u63a8\u8350)"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-groovy",children:"pipeline {\n    triggers {\n        // \u6bcf 5 \u5206\u949f\u68c0\u67e5\u4e00\u6b21\u4ee3\u7801\u53d8\u66f4\n        pollSCM('H/5 * * * *')\n    }\n    // ...\n}\n"})}),"\n",(0,l.jsx)(n.admonition,{title:"\u6027\u80fd\u8b66\u544a",type:"warning",children:(0,l.jsx)(n.p,{children:"\u8f6e\u8be2\u65b9\u5f0f\u6548\u7387\u4f4e\u4e0b\uff0c\u4f1a\u5bf9 Git \u670d\u52a1\u5668\u9020\u6210\u538b\u529b\uff0c\u4e0d\u63a8\u8350\u5728\u751f\u4ea7\u73af\u5883\u4f7f\u7528\u3002"})}),"\n",(0,l.jsx)(n.h2,{id:"4-\u5e38\u7528-pipeline-\u8bed\u6cd5",children:"4. \u5e38\u7528 Pipeline \u8bed\u6cd5"}),"\n",(0,l.jsx)(n.h3,{id:"41-\u6761\u4ef6\u6267\u884c",children:"4.1 \u6761\u4ef6\u6267\u884c"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-groovy",children:"stage('Deploy to Prod') {\n    when {\n        branch 'main'           // \u53ea\u5728 main \u5206\u652f\u6267\u884c\n        environment name: 'ENV', value: 'prod'  // \u73af\u5883\u53d8\u91cf\u6761\u4ef6\n    }\n    steps {\n        sh './deploy.sh'\n    }\n}\n"})}),"\n",(0,l.jsx)(n.h3,{id:"42-\u5e76\u884c\u6267\u884c",children:"4.2 \u5e76\u884c\u6267\u884c"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-groovy",children:"stage('Parallel Tests') {\n    parallel {\n        stage('Unit Tests') {\n            steps {\n                sh 'mvn test'\n            }\n        }\n        stage('Integration Tests') {\n            steps {\n                sh 'mvn verify'\n            }\n        }\n        stage('Code Analysis') {\n            steps {\n                sh 'mvn sonar:sonar'\n            }\n        }\n    }\n}\n"})}),"\n",(0,l.jsx)(n.h3,{id:"43-\u9519\u8bef\u5904\u7406",children:"4.3 \u9519\u8bef\u5904\u7406"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-groovy",children:"stage('Deploy') {\n    steps {\n        script {\n            try {\n                sh './deploy.sh'\n            } catch (Exception e) {\n                echo \"\u90e8\u7f72\u5931\u8d25: ${e.message}\"\n                currentBuild.result = 'UNSTABLE'\n            }\n        }\n    }\n}\n"})}),"\n",(0,l.jsx)(n.h3,{id:"44-\u8f93\u5165\u786e\u8ba4",children:"4.4 \u8f93\u5165\u786e\u8ba4"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-groovy",children:"stage('Deploy to Production') {\n    steps {\n        input message: '\u786e\u8ba4\u90e8\u7f72\u5230\u751f\u4ea7\u73af\u5883\uff1f', ok: '\u90e8\u7f72'\n        sh './deploy-prod.sh'\n    }\n}\n"})}),"\n",(0,l.jsx)(n.h2,{id:"5-\u6700\u4f73\u5b9e\u8df5",children:"5. \u6700\u4f73\u5b9e\u8df5"}),"\n",(0,l.jsx)(n.h3,{id:"51-jenkinsfile-\u5b58\u653e\u4f4d\u7f6e",children:"5.1 Jenkinsfile \u5b58\u653e\u4f4d\u7f6e"}),"\n",(0,l.jsxs)(n.p,{children:["\u5c06 ",(0,l.jsx)(n.code,{children:"Jenkinsfile"})," \u653e\u5728\u4ee3\u7801\u4ed3\u5e93\u6839\u76ee\u5f55\uff0c\u5b9e\u73b0 ",(0,l.jsx)(n.strong,{children:"Pipeline as Code"}),"\uff1a"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{children:"my-project/\n\u251c\u2500\u2500 src/\n\u251c\u2500\u2500 Dockerfile\n\u251c\u2500\u2500 Jenkinsfile      # \u6d41\u6c34\u7ebf\u5b9a\u4e49\n\u2514\u2500\u2500 README.md\n"})}),"\n",(0,l.jsx)(n.h3,{id:"52-\u5171\u4eab\u5e93",children:"5.2 \u5171\u4eab\u5e93"}),"\n",(0,l.jsx)(n.p,{children:"\u5bf9\u4e8e\u591a\u4e2a\u9879\u76ee\u5171\u7528\u7684\u903b\u8f91\uff0c\u4f7f\u7528 Shared Library\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-groovy",children:"// vars/buildJavaApp.groovy\ndef call(Map config) {\n    pipeline {\n        agent any\n        stages {\n            stage('Build') {\n                steps {\n                    sh \"mvn clean package -P${config.profile}\"\n                }\n            }\n        }\n    }\n}\n"})}),"\n",(0,l.jsx)(n.p,{children:"\u4f7f\u7528\u65b9\u5f0f\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-groovy",children:"@Library('my-shared-library') _\nbuildJavaApp(profile: 'production')\n"})}),"\n",(0,l.jsx)(n.h3,{id:"53-\u51ed\u636e\u7ba1\u7406",children:"5.3 \u51ed\u636e\u7ba1\u7406"}),"\n",(0,l.jsx)(n.p,{children:"\u6c38\u8fdc\u4e0d\u8981\u5728 Jenkinsfile \u4e2d\u786c\u7f16\u7801\u5bc6\u7801\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-groovy",children:"// \u6b63\u786e\u505a\u6cd5\nwithCredentials([string(credentialsId: 'api-token', variable: 'TOKEN')]) {\n    sh 'curl -H \"Authorization: Bearer $TOKEN\" https://api.example.com'\n}\n\n// \u9519\u8bef\u505a\u6cd5 - \u6c38\u8fdc\u4e0d\u8981\u8fd9\u6837\u505a\uff01\n// sh 'curl -H \"Authorization: Bearer abc123\" https://api.example.com'\n"})})]})}function h(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,l.jsx)(n,{...e,children:(0,l.jsx)(c,{...e})}):c(e)}}}]);